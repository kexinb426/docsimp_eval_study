<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Evaluation Workbench</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .workbench-container { display: flex; flex-direction: column; height: 100vh; }
        .workbench-header { padding: 10px 20px; background-color: #fff; border-bottom: 2px solid #dee4e9; text-align: center; flex-shrink: 0; }
        .workbench-body { display: flex; flex-grow: 1; overflow: hidden; }
        .source-panel { flex: 0 0 35%; padding: 20px; background-color: #e9eef2; border-right: 2px solid #dee4e9; overflow-y: auto; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #dee4e9; background-color: #fdfdfd; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { font-weight: bold; color: #0056b3; border-bottom: 3px solid #0056b3; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .wizard-page { display: none; margin-bottom: 20px; }
        .wizard-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-context-header { padding: 15px; background-color: #fff; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        .wizard-nav { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wizard-nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; }
        .question-block { margin: 25px 0; border-left: 3px solid #007bff; padding-left: 15px;}
        .question-block label { font-weight: bold; display: block; margin-bottom: 8px; }
        .radio-option-label { display: block; margin-bottom: 5px; }
        #submit-button-container { display: none; text-align: center; padding: 30px; }
        #submit-button { padding: 15px 25px; background-color: #28a745; color: white; border-radius: 8px; font-size: 20px; font-weight: bold; border: none; cursor: pointer; }
        #submit-button:disabled { background-color: #999; }
        mark { background-color: #ffeb3b; padding: 2px 0; border-radius: 3px; }
        .tooltip-container { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 1px solid #0056b3; border-radius: 50%; font-size: 10px; font-weight: bold; color: #0056b3; margin-left: 8px; position: relative; cursor: help; vertical-align: middle; }
        .tooltip-text { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 150%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-weight: normal; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .question-description { font-weight: normal; color: #555; margin-left: 6px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="workbench-container">
    <div class="workbench-header"><h1 id="study-title">Document Simplification Evaluation</h1></div>
    <form id="evaluation-form">
        <div class="workbench-body">
            <aside id="source-panel" class="source-panel"></aside>
            <main class="main-panel">
                <div id="tabs-container" class="tabs"></div>
                <div id="content-container"></div>
                <div id="submit-button-container">
                    <button type="submit" id="submit-button">Submit All Evaluations</button>
                </div>
            </main>
        </div>
    </form>
</div>

<script>
// =======================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLJNvnP5Z1vW1w3MxaLygN-1b7aBU5DRM30i7w3LFRFNXt6AoC7FDgoovhTOEsYWAQ/exec';
const PROLIFIC_COMPLETION_URL = "https://app.prolific.com/submissions/complete?cc=CCDC2886F";
// =======================================================================
// === DATA INJECTION POINT (These will be replaced by Python) ===
const taskData = [
    {
        "title": "Blackrocks Brewery",
        "model_id": "claude_editor",
        "original": "Blackrocks Brewery is a craft brewery in Marquette, Michigan, United States. Former pharmaceutical salesmen David Manson and Andy Langlois opened Blackrocks in 2010, taking the name from a local landmark. They originally brewed their products in the basement of a Victorian-style house and used the building's other two floors as a taproom.\nBy 2013, persistent demand for Blackrocks' beer led Manson and Langlois to add an outdoor patio and increase their brewing capacity. This included purchasing and converting a nearby former Coca-Cola bottling plant. In the early 2020s, they expanded the brewery's taproom into an adjacent property to double its available indoor area. As of 2024, Blackrocks is the largest craft brewery in Michigan's Upper Peninsula. Their most popular beer is 51K, an American IPA.\n\n",
        "simplified": "Blackrocks Brewery is a small beer-making company in Marquette, Michigan. Two men, David Manson and Andy Langlois, started it in 2010. They used to sell medicine before opening the brewery. They named it after a well-known place in the area.\n\nAt first, they made beer in the basement of an old-style house. They used the other parts of the house to serve customers.\n\nIn 2013, many people wanted their beer. So, Manson and Langlois added an outdoor seating area and made more beer. They bought an old Coca-Cola factory nearby to make even more beer.\n\nIn the early 2020s, they made their serving area bigger by using the building next door. This gave them twice as much indoor space.\n\nAs of 2024, Blackrocks is the biggest small beer-making company in the northern part of Michigan. Their most popular beer is called 51K, which is a type of beer known as an American IPA.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Blackrocks Brewery is a craft brewery in Marquette, Michigan, United States.",
                    "simplified_span": "Blackrocks Brewery is a small beer-making company in Marquette, Michigan.",
                    "explanation": "The original specifies that Blackrocks Brewery is a 'craft brewery,' which is a specific type of brewery known for small-scale, independent, and traditional brewing methods. The simplified version describes it as a 'small beer-making company,' which loses the specific connotation of 'craft brewery.'",
                    "suggested_fix": "Change 'small beer-making company' to 'craft brewery.'"
                },
                {
                    "type": "meaning",
                    "original_span": "As of 2024, Blackrocks is the largest craft brewery in Michigan's Upper Peninsula.",
                    "simplified_span": "As of 2024, Blackrocks is the biggest small beer-making company in the northern part of Michigan.",
                    "explanation": "The original specifies that Blackrocks is the largest craft brewery in Michigan's Upper Peninsula, which is a specific geographic area. The simplified version inaccurately describes it as the 'biggest small beer-making company in the northern part of Michigan,' which is less precise and could be misleading.",
                    "suggested_fix": "Change 'biggest small beer-making company in the northern part of Michigan' to 'largest craft brewery in Michigan's Upper Peninsula.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "They used to sell medicine before opening the brewery.",
                    "explanation": "The phrase 'sell medicine' is imprecise and could be clarified to better convey the previous profession of the founders.",
                    "suggested_fix": "They used to work as pharmaceutical salesmen before opening the brewery."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "They named it after a well-known place in the area.",
                    "explanation": "The sentence lacks specificity about what 'it' refers to, which can cause confusion for the reader.",
                    "suggested_fix": "They named the brewery after a well-known place in the area."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "At first, they made beer in the basement of an old-style house. They used the other parts of the house to serve customers.",
                    "explanation": "The sentence structure is repetitive, which affects the fluency of the text.",
                    "suggested_fix": "Initially, they brewed beer in the basement of an old-style house and used the other parts to serve customers."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "In 2013, many people wanted their beer. So, Manson and Langlois added an outdoor seating area and made more beer.",
                    "explanation": "The transition between the sentences is abrupt, affecting the coherence of the text.",
                    "suggested_fix": "In 2013, as demand for their beer increased, Manson and Langlois added an outdoor seating area and expanded their production."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "As of 2024, Blackrocks is the biggest small beer-making company in the northern part of Michigan.",
                    "explanation": "The phrase 'biggest small beer-making company' is contradictory and can be confusing.",
                    "suggested_fix": "As of 2024, Blackrocks is the largest craft brewery in the northern part of Michigan."
                }
            ]
        }
    },
    {
        "title": "Blackrocks Brewery",
        "model_id": "openai_editor",
        "original": "Blackrocks Brewery is a craft brewery in Marquette, Michigan, United States. Former pharmaceutical salesmen David Manson and Andy Langlois opened Blackrocks in 2010, taking the name from a local landmark. They originally brewed their products in the basement of a Victorian-style house and used the building's other two floors as a taproom.\nBy 2013, persistent demand for Blackrocks' beer led Manson and Langlois to add an outdoor patio and increase their brewing capacity. This included purchasing and converting a nearby former Coca-Cola bottling plant. In the early 2020s, they expanded the brewery's taproom into an adjacent property to double its available indoor area. As of 2024, Blackrocks is the largest craft brewery in Michigan's Upper Peninsula. Their most popular beer is 51K, an American IPA.\n\n",
        "simplified": "Blackrocks Brewery is a craft beer company in Marquette, Michigan, USA. David Manson and Andy Langlois, who used to work in pharmaceutical sales, started Blackrocks in 2010. They named it after a local place. At first, they made their beer in the basement of an old Victorian house and used the other two floors for a bar where people could drink their beer.\n\nBy 2013, the beer was so popular that Manson and Langlois decided to expand. They added an outdoor patio and made more beer. They did this by buying an old Coca-Cola bottling plant nearby and turning it into a place for brewing. In the early 2020s, they made the bar area bigger by using a nearby building, doubling the indoor space. As of 2024, Blackrocks is the largest craft brewery in the Upper Peninsula of Michigan. Their best-selling beer is an American IPA called 51K.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "taking the name from a local landmark",
                    "simplified_span": "They named it after a local place",
                    "explanation": "The original specifies that 'Blackrocks' is named after a local landmark, which implies a specific and notable feature, whereas the simplified version uses 'local place,' which is vague and loses the significance of the landmark.",
                    "suggested_fix": "They named it after a local landmark."
                },
                {
                    "type": "meaning",
                    "original_span": "used the building's other two floors as a taproom",
                    "simplified_span": "used the other two floors for a bar where people could drink their beer",
                    "explanation": "The original specifies 'taproom,' which is a specific type of bar focused on serving beer directly from the brewery, while the simplified version uses 'bar,' which is more general and could imply a broader range of services.",
                    "suggested_fix": "used the other two floors as a taproom where people could drink their beer"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "They named it after a local place.",
                    "explanation": "The phrase 'a local place' is vague and does not specify which place the brewery is named after.",
                    "suggested_fix": "They named it after a local landmark called Blackrocks."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "They did this by buying an old Coca-Cola bottling plant nearby and turning it into a place for brewing.",
                    "explanation": "The phrase 'a place for brewing' is somewhat redundant and could be more specific.",
                    "suggested_fix": "They did this by buying an old Coca-Cola bottling plant nearby and converting it into a brewery."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "In the early 2020s, they made the bar area bigger by using a nearby building, doubling the indoor space.",
                    "explanation": "The sentence structure is slightly clunky and could be streamlined for better flow.",
                    "suggested_fix": "In the early 2020s, they expanded the bar area by incorporating a nearby building, effectively doubling the indoor space."
                }
            ]
        }
    },
    {
        "title": "Blackrocks Brewery",
        "model_id": "gemma_editor",
        "original": "Blackrocks Brewery is a craft brewery in Marquette, Michigan, United States. Former pharmaceutical salesmen David Manson and Andy Langlois opened Blackrocks in 2010, taking the name from a local landmark. They originally brewed their products in the basement of a Victorian-style house and used the building's other two floors as a taproom.\nBy 2013, persistent demand for Blackrocks' beer led Manson and Langlois to add an outdoor patio and increase their brewing capacity. This included purchasing and converting a nearby former Coca-Cola bottling plant. In the early 2020s, they expanded the brewery's taproom into an adjacent property to double its available indoor area. As of 2024, Blackrocks is the largest craft brewery in Michigan's Upper Peninsula. Their most popular beer is 51K, an American IPA.\n\n",
        "simplified": "Blackrocks Brewery is a small, independent brewery located in Marquette, Michigan. It was started in 2010 by two former drug sales people, David Manson and Andy Langlois, who chose the name because of a local rock formation. At first, they brewed their beer in the basement of a historic house and used the rest of the house as a place to sell it directly to customers.\n\nBecause people really liked their beer, they started expanding in 2013. They added an outdoor seating area and built a bigger brewing area by buying and renovating an old Coca-Cola bottling plant. In the early 2020s, they also added more space to their taproom by building onto a neighboring property, making it twice as big. \n\nAs of 2024, Blackrocks is now the biggest craft brewery in Michigan\u2019s Upper Peninsula. Their most popular beer is called 51K, and it\u2019s a type of American IPA.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Former pharmaceutical salesmen David Manson and Andy Langlois",
                    "simplified_span": "two former drug sales people, David Manson and Andy Langlois",
                    "explanation": "The simplified text refers to the founders as 'drug sales people,' which could imply illegal drug sales, whereas the original specifies 'pharmaceutical salesmen,' indicating legal, professional sales in the pharmaceutical industry.",
                    "suggested_fix": "Change 'two former drug sales people' to 'two former pharmaceutical salesmen'."
                },
                {
                    "type": "meaning",
                    "original_span": "taking the name from a local landmark",
                    "simplified_span": "who chose the name because of a local rock formation",
                    "explanation": "The simplified text specifies 'a local rock formation,' which is more specific than the original's 'local landmark.' While this is a minor detail, it could mislead readers about the nature of the landmark.",
                    "suggested_fix": "Change 'because of a local rock formation' to 'from a local landmark'."
                },
                {
                    "type": "meaning",
                    "original_span": "increase their brewing capacity",
                    "simplified_span": "built a bigger brewing area",
                    "explanation": "The original text emphasizes increasing brewing capacity, which involves more than just physical space, such as equipment and production capabilities. The simplified text focuses only on the physical expansion.",
                    "suggested_fix": "Change 'built a bigger brewing area' to 'expanded their brewing capacity'."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "two former drug sales people",
                    "explanation": "The term 'drug sales people' is imprecise and could be interpreted in various ways, potentially leading to confusion.",
                    "suggested_fix": "two former pharmaceutical sales representatives"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Because people really liked their beer, they started expanding in 2013.",
                    "explanation": "The sentence structure is somewhat clunky and could be made more concise for better fluency.",
                    "suggested_fix": "Due to the popularity of their beer, they began expanding in 2013."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "making it twice as big",
                    "explanation": "The phrase 'twice as big' is vague without a clear reference point for the original size.",
                    "suggested_fix": "doubling its original size"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "As of 2024, Blackrocks is now the biggest craft brewery in Michigan\u2019s Upper Peninsula.",
                    "explanation": "The use of 'now' with 'As of 2024' is redundant and can be simplified.",
                    "suggested_fix": "As of 2024, Blackrocks is the biggest craft brewery in Michigan\u2019s Upper Peninsula."
                }
            ]
        }
    }
];
// =======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    if (typeof taskData === 'string' || WEB_APP_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
        document.body.innerHTML = '<h1>Error: Data not injected or Web App URL not set in template.html.</h1>';
        return;
    }

    // --- All variables defined here are shared by the functions below ---
    const sourcePanel = document.getElementById('source-panel');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const submitContainer = document.getElementById('submit-button-container');
    let prolificId = '';
    
    // Shuffle the data first, so we can define the original text based on the first item.
    shuffleArray(taskData);
    const originalSourceHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;


    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }


    function buildInterface() {
        const urlParams = new URLSearchParams(window.location.search);
        prolificId = urlParams.get('PROLIFIC_PID') || 'PROLIFIC_ID_NOT_FOUND';

        // --- NEW: Shuffle the taskData array right after it's loaded ---
        shuffleArray(taskData);
        
        sourcePanel.innerHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;
        
        let tabsHTML = '<button type="button" class="tab-button active" data-tab="instructions">Instructions</button>';
        taskData.forEach((_, i) => { tabsHTML += `<button type="button" class="tab-button" data-tab="s${i}">Version ${i + 1}</button>`; });
        tabsHTML += '<button type="button" class="tab-button" data-tab="comparison">Final Comparison</button>';
        tabsContainer.innerHTML = tabsHTML;

        let contentHTML = `<div id="instructions" class="tab-content active"><h3>Instructions</h3><p>Please evaluate each simplification by proceeding through the tabs. Within each tab, use the 'Next' and 'Previous' buttons to move through the evaluation pages.</p></div>`;
        taskData.forEach((simp, i) => { contentHTML += generateSimplificationTabHTML(simp, i); });
        contentHTML += generateFinalComparisonHTML(taskData);
        contentContainer.innerHTML = contentHTML;

        initializeInteractivity();
    }

    function generateSimplificationTabHTML(simplification, simpIndex) {
        const pages = [];
        const escapeRegExp = (string) => string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
        const createRadioOption = (name, value, labelText, tooltipText) => `<label class="radio-option-label"><input type="radio" name="${name}" value="${value}"> ${labelText} <span class="tooltip-container">i<span class="tooltip-text">${tooltipText}</span></span></label>`;
        
        const overallQuestionsHTML = simplification.evaluation.overall_questions.map(q => {
            const labelParts = q.label.split(/:(.*)/s);
            const mainLabel = labelParts[0] + ':';
            const description = labelParts[1] || '';
            const optionsHTML = q.options.map(opt => createRadioOption(`s${simpIndex}_${q.key}`, opt.label, opt.label, opt.description)).join('');
            return `<div class="question-block"><label>${mainLabel}<span class="question-description">${description}</span></label>${optionsHTML}</div>`;
        }).join('');
        pages.push({type: 'overall', content: `<h3>Overall Quality Questions</h3><div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>${overallQuestionsHTML}` });

        simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
            const highlightedSimplified = issue.simplified_span ? simplification.simplified.replace(new RegExp(escapeRegExp(issue.simplified_span), 'g'), `<mark>${issue.simplified_span}</mark>`) : simplification.simplified;
            let contextHTML = `<div class="context-sub-header"></div><p>${highlightedSimplified.replace(/\n/g, '<br>')}</p>`;
            const severityOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Major", "Major Issue", "Significantly harms comprehension or quality.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Minor", "Minor Issue", "Small issue that could be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Not an issue", "No Issue", "The text is acceptable as is.");
            const explanationOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Correct", "Correct", "Identifies and describes the main issue.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Partially Correct", "Partially Correct", "Identifies a real issue, but the explanation is incomplete or inaccurate.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Incorrect", "Incorrect", "Describes a problem that doesn't actually exist.");
            const fixOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Solves the issue", "Solves", "This is a clear and successful improvement.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Partial improvement", "Partial", "The fix is slightly better, but the text could still be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "No difference", "No Difference", "The fix is neither better nor worse than the original text.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Worse", "Worse", "The suggested fix is actually a regression.");
            pages.push({type: issue.type, originalSpan: issue.original_span, content: `<h3>Span Evaluation (${issueIndex + 1}/${simplification.evaluation.simplicity_issues.length})</h3><div class="wizard-context-header">${contextHTML}</div><div class="question-block"><p><strong>Explanation:</strong> ${issue.explanation}</p><p><strong>Suggested Fix:</strong> <span style="color:#28a745;">${issue.suggested_fix}</span></p></div><div class="question-block"><label>How would you rate this issue?</label>${severityOptions}</div><div class="question-block"><label>How accurate is the LLM's explanation?</label>${explanationOptions}</div><div class="question-block"><label>Is the suggested fix an improvement?</label>${fixOptions}</div>`});
        });
        
        pages.push({
            type: 'feedback',
            content: `<h3>Additional Feedback</h3>
                    <div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>
                    <div class="question-block">
                        <label>Did you notice any other issues while reading that were not highlighted? If so, please paste relevant spans here or describe them below.</label>
                        <textarea name="s${simpIndex}_missed_issues_text" class="missed-issues-textarea" data-simp-index="${simpIndex}" rows="5" style="width: 95%; padding: 5px;"></textarea>
                        <div style="margin-top: 10px;"><label><input type="checkbox" name="s${simpIndex}_missed_issues_none" class="missed-issues-none-checkbox" data-simp-index="${simpIndex}" value="None"> I did not notice any other issues.</label></div>
                    </div>`
        });
        const wizardPagesHTML = pages.map((page, pageIndex) => `<div class="wizard-page" data-page-index="${pageIndex}" data-issue-type="${page.type}" data-original-span="${page.originalSpan || ''}">${page.content}<div class="wizard-nav"><button type="button" class="wizard-nav-button prev" style="visibility: ${pageIndex > 0 ? 'visible' : 'hidden'};">&laquo; Previous</button><span>Page ${pageIndex + 1} of ${pages.length}</span><button type="button" class="wizard-nav-button next" style="visibility: ${pageIndex < pages.length - 1 ? 'visible' : 'hidden'};">Next &raquo;</button></div></div>`).join('');
        return `<div id="s${simpIndex}" class="tab-content wizard-container">${wizardPagesHTML}</div>`;
    }
    
    function generateFinalComparisonHTML(data) {
        let optionsHTML = data.map((task, i) => `<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="${task.model_id}"> Version ${i+1}</label>`).join('');
        return `<div id="comparison" class="tab-content"><h3>Final Comparison</h3><div class="question-block"><label>Which simplification was the best overall?</label>${optionsHTML}<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="All Equal"> All were about equal</label></div></div>`;
    }

    function highlightSourceSpan(spanText) {
        sourcePanel.innerHTML = originalSourceHTML;
        
        if (spanText && spanText !== 'null') {
            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const highlightedHTML = originalSourceHTML.replace(
                new RegExp(escapeRegExp(spanText), 'g'),
                `<mark>${spanText}</mark>`
            );
            sourcePanel.innerHTML = highlightedHTML;
        }
    }

    function initializeInteractivity() {
        // --- THIS FUNCTION NOW LIVES INSIDE INITIALIZEINTERACTIVITY ---
        function highlightSourceSpan(spanText) {
            // Always start with the clean, un-highlighted version of the source text
            sourcePanel.innerHTML = originalSourceHTML;
            
            // If there's a span to highlight, find it and wrap it in <mark> tags
            if (spanText && spanText !== 'null') {
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const highlightedHTML = originalSourceHTML.replace(
                    new RegExp(escapeRegExp(spanText), 'g'),
                    `<mark>${spanText}</mark>`
                );
                sourcePanel.innerHTML = highlightedHTML;
            }
        }

        // Tab switching logic
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                if(tabsContainer.querySelector('.active')) tabsContainer.querySelector('.active').classList.remove('active');
                if(contentContainer.querySelector('.tab-content.active')) contentContainer.querySelector('.tab-content.active').classList.remove('active');
                e.target.classList.add('active');
                const newTabContent = contentContainer.querySelector(`#${tabId}`);
                if (newTabContent) newTabContent.classList.add('active');
                submitContainer.style.display = (tabId === 'comparison') ? 'block' : 'none';
                
                highlightSourceSpan(null);
            }
        });

        // Wizard navigation logic
        contentContainer.addEventListener('click', (e) => {
            if (e.target.matches('.wizard-nav-button')) {
                const wizardContainer = e.target.closest('.wizard-container');
                const currentPage = e.target.closest('.wizard-page');
                let currentPageIndex = parseInt(currentPage.dataset.pageIndex, 10);
                currentPageIndex += e.target.matches('.next') ? 1 : -1;
                const newActivePage = wizardContainer.querySelector(`.wizard-page[data-page-index="${currentPageIndex}"]`);
                if (newActivePage) {
                    currentPage.classList.remove('active');
                    newActivePage.classList.add('active');
                    const spanToHighlight = newActivePage.dataset.originalSpan;
                    highlightSourceSpan(spanToHighlight);
                }
            }
        });
        
        document.querySelectorAll('.wizard-container').forEach(container => container.querySelector('.wizard-page')?.classList.add('active'));
        
        document.getElementById('evaluation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting... Please Wait';

            const allFormData = new FormData(document.getElementById('evaluation-form'));
            const allSubmissions = [];

            taskData.forEach((simplification, simpIndex) => {
                const dataToSubmit = {};
                
                dataToSubmit['Prolific ID'] = prolificId;
                dataToSubmit['Document Title'] = simplification.title;
                dataToSubmit['Simplification Model ID'] = simplification.model_id;

                simplification.evaluation.overall_questions.forEach(q => {
                    dataToSubmit[q.label] = allFormData.get(`s${simpIndex}_${q.key}`) || '';
                });

                simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
                    const spanNum = issueIndex + 1;
                    dataToSubmit[`Span ${spanNum} Text`] = issue.simplified_span || 'SPAN_NOT_FOUND';
                    dataToSubmit[`Span ${spanNum} - Issue Severity`] = allFormData.get(`s${simpIndex}_span${issueIndex}_severity`) || '';
                    dataToSubmit[`Span ${spanNum} - Explanation Accuracy`] = allFormData.get(`s${simpIndex}_span${issueIndex}_explanation`) || '';
                    dataToSubmit[`Span ${spanNum} - Fix Improvement`] = allFormData.get(`s${simpIndex}_span${issueIndex}_fix`) || '';
                });

                const missedIssuesText = allFormData.get(`s${simpIndex}_missed_issues_text`);
                const isNoneChecked = allFormData.get(`s${simpIndex}_missed_issues_none`);
                dataToSubmit['Missed Issues Text'] = isNoneChecked ? 'None' : missedIssuesText || '';
                dataToSubmit['No Missed Issues Found'] = isNoneChecked ? 'Checked' : '';
                
                if (simpIndex === taskData.length - 1) {
                    dataToSubmit['Final Comparison Choice'] = allFormData.get('final_choice') || '';
                }
                
                allSubmissions.push(dataToSubmit);
            });

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(allSubmissions),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === 'success') {
                    window.location.href = PROLIFIC_COMPLETION_URL;
                } else {
                    throw new Error(data.message || 'The script reported an unknown error.');
                }
            })
            .catch(error => {
                console.error("A critical error occurred during submission:", error);
                alert("A submission error occurred. Your responses could not be saved. Please contact the researcher.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit All Evaluations';
            });
        });
    }
    buildInterface();
});
</script>

</body>
</html>