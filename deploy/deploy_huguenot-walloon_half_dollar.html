<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Evaluation Workbench</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .workbench-container { display: flex; flex-direction: column; height: 100vh; }
        .workbench-header { padding: 10px 20px; background-color: #fff; border-bottom: 2px solid #dee4e9; text-align: center; flex-shrink: 0; }
        .workbench-body { display: flex; flex-grow: 1; overflow: hidden; }
        .source-panel { flex: 0 0 35%; padding: 20px; background-color: #e9eef2; border-right: 2px solid #dee4e9; overflow-y: auto; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #dee4e9; background-color: #fdfdfd; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { font-weight: bold; color: #0056b3; border-bottom: 3px solid #0056b3; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .wizard-page { display: none; margin-bottom: 20px; }
        .wizard-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-context-header { padding: 15px; background-color: #fff; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        .wizard-nav { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wizard-nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; }
        .question-block { margin: 25px 0; border-left: 3px solid #007bff; padding-left: 15px;}
        .question-block label { font-weight: bold; display: block; margin-bottom: 8px; }
        .radio-option-label { display: block; margin-bottom: 5px; }
        #submit-button-container { display: none; text-align: center; padding: 30px; }
        #submit-button { padding: 15px 25px; background-color: #28a745; color: white; border-radius: 8px; font-size: 20px; font-weight: bold; border: none; cursor: pointer; }
        #submit-button:disabled { background-color: #999; }
        mark { background-color: #ffeb3b; padding: 2px 0; border-radius: 3px; }
        .tooltip-container { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 1px solid #0056b3; border-radius: 50%; font-size: 10px; font-weight: bold; color: #0056b3; margin-left: 8px; position: relative; cursor: help; vertical-align: middle; }
        .tooltip-text { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 150%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-weight: normal; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .question-description { font-weight: normal; color: #555; margin-left: 6px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="workbench-container">
    <div class="workbench-header"><h1 id="study-title">Document Simplification Evaluation</h1></div>
    <form id="evaluation-form">
        <div class="workbench-body">
            <aside id="source-panel" class="source-panel"></aside>
            <main class="main-panel">
                <div id="tabs-container" class="tabs"></div>
                <div id="content-container"></div>
                <div id="submit-button-container">
                    <button type="submit" id="submit-button">Submit All Evaluations</button>
                </div>
            </main>
        </div>
    </form>
</div>

<script>
// =======================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLJNvnP5Z1vW1w3MxaLygN-1b7aBU5DRM30i7w3LFRFNXt6AoC7FDgoovhTOEsYWAQ/exec';
const PROLIFIC_COMPLETION_URL = "https://app.prolific.com/submissions/complete?cc=C3D31568D";
// =======================================================================
// === DATA INJECTION POINT (These will be replaced by Python) ===
const taskData = [
    {
        "title": "Huguenot-Walloon half dollar",
        "model_id": "claude_editor",
        "original": "The Huguenot-Walloon half dollar or Huguenot-Walloon Tercentenary half dollar is a commemorative coin issued by the United States Bureau of the Mint in 1924. It marks the 300th anniversary of the voyage of the Nieuw Nederlandt which landed in the New York area in 1624. Many of the passengers were Huguenots from France or French-speaking  Walloons from what is now Belgium; they became early settlers of New York State and the surrounding area.\nA commission run by the Federal Council of Churches in America sought issuance of a half dollar to mark the anniversary, and the bill passed through Congress without opposition in 1923 and was signed by President Warren G. Harding. Sketches were prepared by commission chairman Reverend John Baer Stoudt and converted to plaster models by the Mint's aging chief engraver, George T. Morgan. The models were initially rejected by the Commission of Fine Arts, which required revisions under the supervision of Buffalo nickel designer James Earle Fraser.\nOf the 300,000 coins authorized by Congress, fewer than half were actually struck, and of these, 55,000 were returned to the Mint and released into circulation. The coin excited some controversy because of its sponsorship by a religious group. The choice of William the Silent and Gaspard de Coligny to appear on the obverse was also questioned as the men are considered martyrs by the Huguenots and died decades before the voyage of the Nieuw Nederlandt. The coins are currently valued in the hundreds of dollars, depending on condition.\n\n",
        "simplified": "The United States made a special coin in 1924 called the Huguenot-Walloon half dollar. This coin celebrated the 300th anniversary of a ship called the Nieuw Nederlandt arriving in New York in 1624. Many people on this ship were Huguenots from France and Walloons from what is now Belgium. These people helped start new communities in New York and nearby areas.\n\nA group of churches asked the government to make this coin. President Warren G. Harding agreed, and Congress approved it in 1923. A church leader named John Baer Stoudt drew the first designs. George T. Morgan, an older coin designer, turned these drawings into 3D models. At first, an art committee didn't like the designs. They asked for changes, which were overseen by James Earle Fraser, who had designed another famous coin.\n\nThe government allowed 300,000 coins to be made, but less than half were actually produced. Of these, 55,000 were later put into regular use as money. Some people didn't like that a religious group was involved in making the coin. Others questioned why William the Silent and Gaspard de Coligny were on the coin, as these men died long before the ship's voyage.\n\nToday, these coins are worth hundreds of dollars, depending on how well they've been kept.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "A commission run by the Federal Council of Churches in America sought issuance of a half dollar to mark the anniversary, and the bill passed through Congress without opposition in 1923 and was signed by President Warren G. Harding.",
                    "simplified_span": "A group of churches asked the government to make this coin. President Warren G. Harding agreed, and Congress approved it in 1923.",
                    "explanation": "The simplified text implies that President Harding's agreement was a separate step before Congress's approval, whereas the original text indicates that the bill passed through Congress without opposition and was then signed by the President.",
                    "suggested_fix": "Revise to: 'A group of churches asked the government to make this coin, and Congress approved it without opposition in 1923, with President Warren G. Harding signing it into law.'"
                },
                {
                    "type": "meaning",
                    "original_span": "Sketches were prepared by commission chairman Reverend John Baer Stoudt and converted to plaster models by the Mint's aging chief engraver, George T. Morgan.",
                    "simplified_span": "A church leader named John Baer Stoudt drew the first designs. George T. Morgan, an older coin designer, turned these drawings into 3D models.",
                    "explanation": "The simplified text omits that John Baer Stoudt was the commission chairman, which is relevant to understanding his role and authority in the process.",
                    "suggested_fix": "Revise to: 'John Baer Stoudt, the commission chairman, drew the first designs. George T. Morgan, an older coin designer, turned these drawings into 3D models.'"
                },
                {
                    "type": "meaning",
                    "original_span": "The models were initially rejected by the Commission of Fine Arts, which required revisions under the supervision of Buffalo nickel designer James Earle Fraser.",
                    "simplified_span": "At first, an art committee didn't like the designs. They asked for changes, which were overseen by James Earle Fraser, who had designed another famous coin.",
                    "explanation": "The simplified text does not specify that the 'art committee' is the Commission of Fine Arts, which is a specific and relevant detail.",
                    "suggested_fix": "Revise to: 'At first, the Commission of Fine Arts didn't like the designs. They asked for changes, which were overseen by James Earle Fraser, who had designed another famous coin.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "President Warren G. Harding agreed, and Congress approved it in 1923.",
                    "explanation": "The sentence structure is slightly clunky due to the use of 'agreed' and 'approved' in close succession, which can make the sentence feel disjointed.",
                    "suggested_fix": "President Warren G. Harding agreed to the proposal, and Congress approved it in 1923."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "George T. Morgan, an older coin designer, turned these drawings into 3D models.",
                    "explanation": "The phrase 'an older coin designer' is somewhat awkward and could be more smoothly integrated into the sentence.",
                    "suggested_fix": "George T. Morgan, a veteran coin designer, turned these drawings into 3D models."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "At first, an art committee didn't like the designs.",
                    "explanation": "The phrase 'At first' is a bit abrupt and could be improved with a smoother transition to enhance the flow of the narrative.",
                    "suggested_fix": "Initially, an art committee didn't approve of the designs."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The government allowed 300,000 coins to be made, but less than half were actually produced.",
                    "explanation": "The phrase 'less than half were actually produced' is slightly imprecise and could be clarified for better understanding.",
                    "suggested_fix": "The government allowed 300,000 coins to be made, but only about 150,000 were actually produced."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Some people didn't like that a religious group was involved in making the coin.",
                    "explanation": "The sentence lacks specificity about why the involvement of a religious group was controversial, which could leave readers unclear about the issue.",
                    "suggested_fix": "Some people were concerned about the separation of church and state due to a religious group's involvement in making the coin."
                }
            ]
        }
    },
    {
        "title": "Huguenot-Walloon half dollar",
        "model_id": "openai_editor",
        "original": "The Huguenot-Walloon half dollar or Huguenot-Walloon Tercentenary half dollar is a commemorative coin issued by the United States Bureau of the Mint in 1924. It marks the 300th anniversary of the voyage of the Nieuw Nederlandt which landed in the New York area in 1624. Many of the passengers were Huguenots from France or French-speaking  Walloons from what is now Belgium; they became early settlers of New York State and the surrounding area.\nA commission run by the Federal Council of Churches in America sought issuance of a half dollar to mark the anniversary, and the bill passed through Congress without opposition in 1923 and was signed by President Warren G. Harding. Sketches were prepared by commission chairman Reverend John Baer Stoudt and converted to plaster models by the Mint's aging chief engraver, George T. Morgan. The models were initially rejected by the Commission of Fine Arts, which required revisions under the supervision of Buffalo nickel designer James Earle Fraser.\nOf the 300,000 coins authorized by Congress, fewer than half were actually struck, and of these, 55,000 were returned to the Mint and released into circulation. The coin excited some controversy because of its sponsorship by a religious group. The choice of William the Silent and Gaspard de Coligny to appear on the obverse was also questioned as the men are considered martyrs by the Huguenots and died decades before the voyage of the Nieuw Nederlandt. The coins are currently valued in the hundreds of dollars, depending on condition.\n\n",
        "simplified": "The Huguenot-Walloon half dollar is a special coin made in 1924 by the U.S. Mint. It was created to celebrate 300 years since the Nieuw Nederlandt ship arrived in the New York area in 1624. Many people on the ship were Huguenots from France or French-speaking Walloons from what is now Belgium. They helped settle New York State.\n\nA group called the Federal Council of Churches in America wanted a half dollar coin made for the anniversary. The idea was approved by Congress without any disagreement in 1923 and signed into law by President Warren G. Harding. Reverend John Baer Stoudt created sketches for the coin, which were turned into models by George T. Morgan, the Mint's chief engraver. The Commission of Fine Arts did not approve the first models, so changes were made with help from James Earle Fraser, who designed the Buffalo nickel.\n\nAlthough Congress allowed 300,000 coins to be made, less than half were produced. Of these, 55,000 were sent back to the Mint and put into circulation as money. The coin caused some disagreement because a religious group requested it. People also questioned why William the Silent and Gaspard de Coligny were pictured on the front. These men are seen as heroes by the Huguenots, but they died many years before the Nieuw Nederlandt's voyage. Today, the coins are worth several hundred dollars, depending on their condition.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "The coin excited some controversy because of its sponsorship by a religious group.",
                    "simplified_span": "The coin caused some disagreement because a religious group requested it.",
                    "explanation": "The original text states that the coin caused controversy due to its sponsorship by a religious group, implying a broader and more significant issue than just a 'disagreement' caused by a request. The term 'sponsorship' suggests a formal and possibly financial backing, which is not captured by 'requested.'",
                    "suggested_fix": "The coin caused some controversy because it was sponsored by a religious group."
                },
                {
                    "type": "meaning",
                    "original_span": "The choice of William the Silent and Gaspard de Coligny to appear on the obverse was also questioned as the men are considered martyrs by the Huguenots and died decades before the voyage of the Nieuw Nederlandt.",
                    "simplified_span": "People also questioned why William the Silent and Gaspard de Coligny were pictured on the front. These men are seen as heroes by the Huguenots, but they died many years before the Nieuw Nederlandt's voyage.",
                    "explanation": "The original text emphasizes that William the Silent and Gaspard de Coligny are considered martyrs by the Huguenots, which is a stronger and more specific term than 'heroes.' The term 'martyrs' implies they died for their beliefs, which is significant to the Huguenots' history and identity.",
                    "suggested_fix": "People also questioned why William the Silent and Gaspard de Coligny were pictured on the front. These men are considered martyrs by the Huguenots and died many years before the Nieuw Nederlandt's voyage."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Nieuw Nederlandt",
                    "explanation": "The term 'Nieuw Nederlandt' is not commonly known and may confuse readers unfamiliar with historical references.",
                    "suggested_fix": "New Netherland"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Federal Council of Churches in America",
                    "explanation": "The name of this group might not be familiar to all readers, and it could benefit from a brief explanation of its role or significance.",
                    "suggested_fix": "Federal Council of Churches in America, a religious organization"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Reverend John Baer Stoudt created sketches for the coin, which were turned into models by George T. Morgan, the Mint's chief engraver.",
                    "explanation": "The sentence contains multiple clauses that could be simplified for better readability.",
                    "suggested_fix": "Reverend John Baer Stoudt created sketches for the coin. These sketches were turned into models by George T. Morgan, the Mint's chief engraver."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The Commission of Fine Arts did not approve the first models, so changes were made with help from James Earle Fraser, who designed the Buffalo nickel.",
                    "explanation": "The sentence contains multiple clauses that could be simplified for better readability.",
                    "suggested_fix": "The Commission of Fine Arts did not approve the first models. Changes were made with help from James Earle Fraser, who designed the Buffalo nickel."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "less than half were produced",
                    "explanation": "The phrase 'less than half' is vague and could be more precise to improve clarity.",
                    "suggested_fix": "only about 150,000 were produced"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The coin caused some disagreement because a religious group requested it.",
                    "explanation": "The sentence is somewhat vague and could be more specific about the nature of the disagreement.",
                    "suggested_fix": "The coin caused controversy because it was requested by a religious group, which some people felt was inappropriate for a government-issued coin."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "People also questioned why William the Silent and Gaspard de Coligny were pictured on the front.",
                    "explanation": "The sentence could be clearer about the reason for questioning the choice of figures on the coin.",
                    "suggested_fix": "People questioned why William the Silent and Gaspard de Coligny, who were not directly related to the Nieuw Nederlandt voyage, were pictured on the front."
                }
            ]
        }
    },
    {
        "title": "Huguenot-Walloon half dollar",
        "model_id": "gemma_editor",
        "original": "The Huguenot-Walloon half dollar or Huguenot-Walloon Tercentenary half dollar is a commemorative coin issued by the United States Bureau of the Mint in 1924. It marks the 300th anniversary of the voyage of the Nieuw Nederlandt which landed in the New York area in 1624. Many of the passengers were Huguenots from France or French-speaking  Walloons from what is now Belgium; they became early settlers of New York State and the surrounding area.\nA commission run by the Federal Council of Churches in America sought issuance of a half dollar to mark the anniversary, and the bill passed through Congress without opposition in 1923 and was signed by President Warren G. Harding. Sketches were prepared by commission chairman Reverend John Baer Stoudt and converted to plaster models by the Mint's aging chief engraver, George T. Morgan. The models were initially rejected by the Commission of Fine Arts, which required revisions under the supervision of Buffalo nickel designer James Earle Fraser.\nOf the 300,000 coins authorized by Congress, fewer than half were actually struck, and of these, 55,000 were returned to the Mint and released into circulation. The coin excited some controversy because of its sponsorship by a religious group. The choice of William the Silent and Gaspard de Coligny to appear on the obverse was also questioned as the men are considered martyrs by the Huguenots and died decades before the voyage of the Nieuw Nederlandt. The coins are currently valued in the hundreds of dollars, depending on condition.\n\n",
        "simplified": "In 1924, the United States Mint made a special coin called the Huguenot-Walloon half dollar to celebrate a historic event. This coin marked the 300th anniversary of a ship called the Nieuw Nederlandt, which arrived in the New York area in 1624. Many people on board were Huguenots \u2013 French Protestants \u2013 and French-speaking Walloons \u2013 people from what is now Belgium. They were among the first settlers in New York and the surrounding region.\n\nA group of churches asked the government to create a coin to honor this anniversary, and Congress approved the idea in 1923. President Warren G. Harding signed the law. A man named Reverend John Baer Stoudt, who led the church group, helped design the coin, and the Mint\u2019s chief engraver, George T. Morgan, made plaster models based on his designs.\n\nHowever, the Commission of Fine Arts, which checked the designs, didn\u2019t like them at first and asked for changes. James Earle Fraser, who designed the Buffalo nickel, helped improve the designs.  Congress had authorized 300,000 coins, but only about 55,000 were actually made and put into circulation.\n\nThe coin caused some debate because it was supported by a religious group. Also, some people questioned why William the Silent and Gaspard de Coligny were chosen to be on the coin\u2019s front \u2013 they are considered martyrs by the Huguenots and died long before the ship arrived. Today, these coins are worth hundreds of dollars, depending on how well they are preserved.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Of the 300,000 coins authorized by Congress, fewer than half were actually struck, and of these, 55,000 were returned to the Mint and released into circulation.",
                    "simplified_span": "Congress had authorized 300,000 coins, but only about 55,000 were actually made and put into circulation.",
                    "explanation": "The simplified text incorrectly states that only about 55,000 coins were made and put into circulation, whereas the original text indicates that fewer than half of the authorized coins were struck, and 55,000 of those were returned to the Mint and released into circulation.",
                    "suggested_fix": "Revise the simplified text to: 'Congress had authorized 300,000 coins, but fewer than half were actually made, and 55,000 of those were returned to the Mint and put into circulation.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "the Huguenot-Walloon half dollar",
                    "explanation": "The term 'Huguenot-Walloon half dollar' might be unfamiliar to general readers and is not explained in the text.",
                    "suggested_fix": "the Huguenot-Walloon half dollar, a commemorative coin"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Nieuw Nederlandt",
                    "explanation": "The name 'Nieuw Nederlandt' is not explained, which might confuse readers unfamiliar with historical ships.",
                    "suggested_fix": "Nieuw Nederlandt, a ship that carried early settlers"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "A group of churches asked the government to create a coin to honor this anniversary, and Congress approved the idea in 1923.",
                    "explanation": "This sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "A group of churches asked the government to create a coin to honor this anniversary. Congress approved the idea in 1923."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "President Warren G. Harding signed the law.",
                    "explanation": "This sentence is abrupt and lacks a transition from the previous sentence.",
                    "suggested_fix": "After Congress approved the idea in 1923, President Warren G. Harding signed the law."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "A man named Reverend John Baer Stoudt, who led the church group, helped design the coin, and the Mint\u2019s chief engraver, George T. Morgan, made plaster models based on his designs.",
                    "explanation": "This sentence is long and contains multiple clauses, which can make it difficult to follow.",
                    "suggested_fix": "Reverend John Baer Stoudt, who led the church group, helped design the coin. The Mint\u2019s chief engraver, George T. Morgan, made plaster models based on Stoudt's designs."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The coin caused some debate because it was supported by a religious group.",
                    "explanation": "The reason for the debate is not fully explained, which could leave readers confused.",
                    "suggested_fix": "The coin caused some debate because it was supported by a religious group, raising concerns about the separation of church and state."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Also, some people questioned why William the Silent and Gaspard de Coligny were chosen to be on the coin\u2019s front \u2013 they are considered martyrs by the Huguenots and died long before the ship arrived.",
                    "explanation": "The sentence structure is somewhat clunky and could be smoother.",
                    "suggested_fix": "Additionally, some questioned the choice of William the Silent and Gaspard de Coligny for the coin\u2019s front, as they are considered Huguenot martyrs and died long before the ship's arrival."
                }
            ]
        }
    }
];
// =======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    if (typeof taskData === 'string' || WEB_APP_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
        document.body.innerHTML = '<h1>Error: Data not injected or Web App URL not set in template.html.</h1>';
        return;
    }

    // --- All variables defined here are shared by the functions below ---
    const sourcePanel = document.getElementById('source-panel');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const submitContainer = document.getElementById('submit-button-container');
    let prolificId = '';
    
    // Shuffle the data first, so we can define the original text based on the first item.
    shuffleArray(taskData);
    const originalSourceHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;


    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }


    function buildInterface() {
        const urlParams = new URLSearchParams(window.location.search);
        prolificId = urlParams.get('PROLIFIC_PID') || 'PROLIFIC_ID_NOT_FOUND';

        // --- NEW: Shuffle the taskData array right after it's loaded ---
        shuffleArray(taskData);
        
        sourcePanel.innerHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;
        
        let tabsHTML = '<button type="button" class="tab-button active" data-tab="instructions">Instructions</button>';
        taskData.forEach((_, i) => { tabsHTML += `<button type="button" class="tab-button" data-tab="s${i}">Version ${i + 1}</button>`; });
        tabsHTML += '<button type="button" class="tab-button" data-tab="comparison">Final Comparison</button>';
        tabsContainer.innerHTML = tabsHTML;

        let contentHTML = `<div id="instructions" class="tab-content active"><h3>Instructions</h3><p>Please evaluate each simplification by proceeding through the tabs. Within each tab, use the 'Next' and 'Previous' buttons to move through the evaluation pages.</p></div>`;
        taskData.forEach((simp, i) => { contentHTML += generateSimplificationTabHTML(simp, i); });
        contentHTML += generateFinalComparisonHTML(taskData);
        contentContainer.innerHTML = contentHTML;

        initializeInteractivity();
    }

    function generateSimplificationTabHTML(simplification, simpIndex) {
        const pages = [];
        const escapeRegExp = (string) => string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
        const createRadioOption = (name, value, labelText, tooltipText) => `<label class="radio-option-label"><input type="radio" name="${name}" value="${value}"> ${labelText} <span class="tooltip-container">i<span class="tooltip-text">${tooltipText}</span></span></label>`;
        
        const overallQuestionsHTML = simplification.evaluation.overall_questions.map(q => {
            const labelParts = q.label.split(/:(.*)/s);
            const mainLabel = labelParts[0] + ':';
            const description = labelParts[1] || '';
            const optionsHTML = q.options.map(opt => createRadioOption(`s${simpIndex}_${q.key}`, opt.label, opt.label, opt.description)).join('');
            return `<div class="question-block"><label>${mainLabel}<span class="question-description">${description}</span></label>${optionsHTML}</div>`;
        }).join('');
        pages.push({type: 'overall', content: `<h3>Overall Quality Questions</h3><div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>${overallQuestionsHTML}` });

        simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
            const highlightedSimplified = issue.simplified_span ? simplification.simplified.replace(new RegExp(escapeRegExp(issue.simplified_span), 'g'), `<mark>${issue.simplified_span}</mark>`) : simplification.simplified;
            let contextHTML = `<div class="context-sub-header"></div><p>${highlightedSimplified.replace(/\n/g, '<br>')}</p>`;
            const severityOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Major", "Major Issue", "Significantly harms comprehension or quality.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Minor", "Minor Issue", "Small issue that could be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Not an issue", "No Issue", "The text is acceptable as is.");
            const explanationOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Correct", "Correct", "Identifies and describes the main issue.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Partially Correct", "Partially Correct", "Identifies a real issue, but the explanation is incomplete or inaccurate.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Incorrect", "Incorrect", "Describes a problem that doesn't actually exist.");
            const fixOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Solves the issue", "Solves", "This is a clear and successful improvement.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Partial improvement", "Partial", "The fix is slightly better, but the text could still be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "No difference", "No Difference", "The fix is neither better nor worse than the original text.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Worse", "Worse", "The suggested fix is actually a regression.");
            pages.push({type: issue.type, originalSpan: issue.original_span, content: `<h3>Span Evaluation (${issueIndex + 1}/${simplification.evaluation.simplicity_issues.length})</h3><div class="wizard-context-header">${contextHTML}</div><div class="question-block"><p><strong>Explanation:</strong> ${issue.explanation}</p><p><strong>Suggested Fix:</strong> <span style="color:#28a745;">${issue.suggested_fix}</span></p></div><div class="question-block"><label>How would you rate this issue?</label>${severityOptions}</div><div class="question-block"><label>How accurate is the LLM's explanation?</label>${explanationOptions}</div><div class="question-block"><label>Is the suggested fix an improvement?</label>${fixOptions}</div>`});
        });
        
        pages.push({
            type: 'feedback',
            content: `<h3>Additional Feedback</h3>
                    <div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>
                    <div class="question-block">
                        <label>Did you notice any other issues while reading that were not highlighted? If so, please paste relevant spans here or describe them below.</label>
                        <textarea name="s${simpIndex}_missed_issues_text" class="missed-issues-textarea" data-simp-index="${simpIndex}" rows="5" style="width: 95%; padding: 5px;"></textarea>
                        <div style="margin-top: 10px;"><label><input type="checkbox" name="s${simpIndex}_missed_issues_none" class="missed-issues-none-checkbox" data-simp-index="${simpIndex}" value="None"> I did not notice any other issues.</label></div>
                    </div>`
        });
        const wizardPagesHTML = pages.map((page, pageIndex) => `<div class="wizard-page" data-page-index="${pageIndex}" data-issue-type="${page.type}" data-original-span="${page.originalSpan || ''}">${page.content}<div class="wizard-nav"><button type="button" class="wizard-nav-button prev" style="visibility: ${pageIndex > 0 ? 'visible' : 'hidden'};">&laquo; Previous</button><span>Page ${pageIndex + 1} of ${pages.length}</span><button type="button" class="wizard-nav-button next" style="visibility: ${pageIndex < pages.length - 1 ? 'visible' : 'hidden'};">Next &raquo;</button></div></div>`).join('');
        return `<div id="s${simpIndex}" class="tab-content wizard-container">${wizardPagesHTML}</div>`;
    }
    
    function generateFinalComparisonHTML(data) {
        let optionsHTML = data.map((task, i) => `<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="${task.model_id}"> Version ${i+1}</label>`).join('');
        return `<div id="comparison" class="tab-content"><h3>Final Comparison</h3><div class="question-block"><label>Which simplification was the best overall?</label>${optionsHTML}<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="All Equal"> All were about equal</label></div></div>`;
    }

    function highlightSourceSpan(spanText) {
        sourcePanel.innerHTML = originalSourceHTML;
        
        if (spanText && spanText !== 'null') {
            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const highlightedHTML = originalSourceHTML.replace(
                new RegExp(escapeRegExp(spanText), 'g'),
                `<mark>${spanText}</mark>`
            );
            sourcePanel.innerHTML = highlightedHTML;
        }
    }

    function initializeInteractivity() {
        // --- THIS FUNCTION NOW LIVES INSIDE INITIALIZEINTERACTIVITY ---
        function highlightSourceSpan(spanText) {
            // Always start with the clean, un-highlighted version of the source text
            sourcePanel.innerHTML = originalSourceHTML;
            
            // If there's a span to highlight, find it and wrap it in <mark> tags
            if (spanText && spanText !== 'null') {
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const highlightedHTML = originalSourceHTML.replace(
                    new RegExp(escapeRegExp(spanText), 'g'),
                    `<mark>${spanText}</mark>`
                );
                sourcePanel.innerHTML = highlightedHTML;
            }
        }

        // Tab switching logic
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                if(tabsContainer.querySelector('.active')) tabsContainer.querySelector('.active').classList.remove('active');
                if(contentContainer.querySelector('.tab-content.active')) contentContainer.querySelector('.tab-content.active').classList.remove('active');
                e.target.classList.add('active');
                const newTabContent = contentContainer.querySelector(`#${tabId}`);
                if (newTabContent) newTabContent.classList.add('active');
                submitContainer.style.display = (tabId === 'comparison') ? 'block' : 'none';
                
                highlightSourceSpan(null);
            }
        });

        // Wizard navigation logic
        contentContainer.addEventListener('click', (e) => {
            if (e.target.matches('.wizard-nav-button')) {
                const wizardContainer = e.target.closest('.wizard-container');
                const currentPage = e.target.closest('.wizard-page');
                let currentPageIndex = parseInt(currentPage.dataset.pageIndex, 10);
                currentPageIndex += e.target.matches('.next') ? 1 : -1;
                const newActivePage = wizardContainer.querySelector(`.wizard-page[data-page-index="${currentPageIndex}"]`);
                if (newActivePage) {
                    currentPage.classList.remove('active');
                    newActivePage.classList.add('active');
                    const spanToHighlight = newActivePage.dataset.originalSpan;
                    highlightSourceSpan(spanToHighlight);
                }
            }
        });
        
        document.querySelectorAll('.wizard-container').forEach(container => container.querySelector('.wizard-page')?.classList.add('active'));
        
        document.getElementById('evaluation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting... Please Wait';

            const allFormData = new FormData(document.getElementById('evaluation-form'));
            const allSubmissions = [];

            taskData.forEach((simplification, simpIndex) => {
                const dataToSubmit = {};
                
                dataToSubmit['Prolific ID'] = prolificId;
                dataToSubmit['Document Title'] = simplification.title;
                dataToSubmit['Simplification Model ID'] = simplification.model_id;

                simplification.evaluation.overall_questions.forEach(q => {
                    dataToSubmit[q.label] = allFormData.get(`s${simpIndex}_${q.key}`) || '';
                });

                simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
                    const spanNum = issueIndex + 1;
                    dataToSubmit[`Span ${spanNum} Text`] = issue.simplified_span || 'SPAN_NOT_FOUND';
                    dataToSubmit[`Span ${spanNum} - Issue Severity`] = allFormData.get(`s${simpIndex}_span${issueIndex}_severity`) || '';
                    dataToSubmit[`Span ${spanNum} - Explanation Accuracy`] = allFormData.get(`s${simpIndex}_span${issueIndex}_explanation`) || '';
                    dataToSubmit[`Span ${spanNum} - Fix Improvement`] = allFormData.get(`s${simpIndex}_span${issueIndex}_fix`) || '';
                });

                const missedIssuesText = allFormData.get(`s${simpIndex}_missed_issues_text`);
                const isNoneChecked = allFormData.get(`s${simpIndex}_missed_issues_none`);
                dataToSubmit['Missed Issues Text'] = isNoneChecked ? 'None' : missedIssuesText || '';
                dataToSubmit['No Missed Issues Found'] = isNoneChecked ? 'Checked' : '';
                
                if (simpIndex === taskData.length - 1) {
                    dataToSubmit['Final Comparison Choice'] = allFormData.get('final_choice') || '';
                }
                
                allSubmissions.push(dataToSubmit);
            });

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(allSubmissions),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === 'success') {
                    window.location.href = PROLIFIC_COMPLETION_URL;
                } else {
                    throw new Error(data.message || 'The script reported an unknown error.');
                }
            })
            .catch(error => {
                console.error("A critical error occurred during submission:", error);
                alert("A submission error occurred. Your responses could not be saved. Please contact the researcher.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit All Evaluations';
            });
        });
    }
    buildInterface();
});
</script>

</body>
</html>