<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Evaluation Workbench</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .workbench-container { display: flex; flex-direction: column; height: 100vh; }
        .workbench-header { padding: 10px 20px; background-color: #fff; border-bottom: 2px solid #dee4e9; text-align: center; flex-shrink: 0; }
        .workbench-body { display: flex; flex-grow: 1; overflow: hidden; }
        .source-panel { flex: 0 0 35%; padding: 20px; background-color: #e9eef2; border-right: 2px solid #dee4e9; overflow-y: auto; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #dee4e9; background-color: #fdfdfd; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { font-weight: bold; color: #0056b3; border-bottom: 3px solid #0056b3; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .wizard-page { display: none; margin-bottom: 20px; }
        .wizard-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-context-header { padding: 15px; background-color: #fff; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        .wizard-nav { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wizard-nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; }
        .question-block { margin: 25px 0; border-left: 3px solid #007bff; padding-left: 15px;}
        .question-block label { font-weight: bold; display: block; margin-bottom: 8px; }
        .radio-option-label { display: block; margin-bottom: 5px; }
        #submit-button-container { display: none; text-align: center; padding: 30px; }
        #submit-button { padding: 15px 25px; background-color: #28a745; color: white; border-radius: 8px; font-size: 20px; font-weight: bold; border: none; cursor: pointer; }
        #submit-button:disabled { background-color: #999; }
        mark { background-color: #ffeb3b; padding: 2px 0; border-radius: 3px; }
        .tooltip-container { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 1px solid #0056b3; border-radius: 50%; font-size: 10px; font-weight: bold; color: #0056b3; margin-left: 8px; position: relative; cursor: help; vertical-align: middle; }
        .tooltip-text { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 150%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-weight: normal; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .question-description { font-weight: normal; color: #555; margin-left: 6px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="workbench-container">
    <div class="workbench-header"><h1 id="study-title">Document Simplification Evaluation</h1></div>
    <form id="evaluation-form">
        <div class="workbench-body">
            <aside id="source-panel" class="source-panel"></aside>
            <main class="main-panel">
                <div id="tabs-container" class="tabs"></div>
                <div id="content-container"></div>
                <div id="submit-button-container">
                    <button type="submit" id="submit-button">Submit All Evaluations</button>
                </div>
            </main>
        </div>
    </form>
</div>

<script>
// =======================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLJNvnP5Z1vW1w3MxaLygN-1b7aBU5DRM30i7w3LFRFNXt6AoC7FDgoovhTOEsYWAQ/exec';
const PROLIFIC_COMPLETION_URL = "https://app.prolific.com/submissions/complete?cc=C6165D21F";
// =======================================================================
// === DATA INJECTION POINT (These will be replaced by Python) ===
const taskData = [
    {
        "title": "Ancestry of the Godwins",
        "model_id": "claude_editor",
        "original": "Very little is known for certain of the ancestry of the Godwins, the family of the last Anglo-Saxon king of England, Harold II. When King Edward the Confessor died in January 1066 his closest relative was his great-nephew, Edgar the \u00c6theling, but he was young and lacked powerful supporters. Harold was the head of the most powerful family in England and Edward's brother-in-law, and he became king. In September 1066 Harold defeated and killed King Harald Hardrada of Norway at the Battle of Stamford Bridge, and Harold was himself defeated and killed the following month by William the Conqueror at the Battle of Hastings.\nThe family is named after Harold's father, Earl Godwin, who had risen to a position of wealth and influence in the 1020s under Danish King Cnut the Great. In 1045 Godwin's daughter, Edith, married King Edward the Confessor, and by the mid-1050s Harold and his brothers had become dominant, almost monopolising the English earldoms. Godwin's origin is obscure. He was probably the son of Wulfnoth Cild, a South Saxon thegn, but Wulfnoth's ancestry is disputed. A few genealogists and historians argue that he was descended from Alfred the Great's elder brother, King \u00c6thelred I (865\u201371), but almost all historians of Anglo-Saxon England reject this theory.",
        "simplified": "Here's a simplified version of the text:\n\nWe don't know much about the family history of Harold II, the last Anglo-Saxon king of England. When King Edward the Confessor died in January 1066, his closest relative was his young great-nephew, Edgar. However, Edgar didn't have strong supporters. Harold, who was the most powerful man in England and Edward's brother-in-law, became king instead.\n\nIn September 1066, Harold defeated and killed the Norwegian King Harald Hardrada in battle. But the next month, Harold himself was killed by William the Conqueror in the Battle of Hastings.\n\nHarold's family is named after his father, Earl Godwin. Godwin became rich and powerful in the 1020s under the Danish King Cnut. In 1045, Godwin's daughter Edith married King Edward. By the mid-1050s, Harold and his brothers controlled most of the important positions in England.\n\nWe're not sure about Godwin's background. He was probably the son of Wulfnoth Cild, a local leader from southern England, but we don't know much about Wulfnoth's family. Some people think Godwin was related to King Alfred the Great's older brother, but most experts don't believe this.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Edgar the \u00c6theling",
                    "simplified_span": "Edgar",
                    "explanation": "The simplified text omits the title 'the \u00c6theling,' which is significant as it denotes Edgar's royal lineage and potential claim to the throne.",
                    "suggested_fix": "Include the title 'the \u00c6theling' to preserve the significance of Edgar's royal status."
                },
                {
                    "type": "meaning",
                    "original_span": "Harold was the head of the most powerful family in England",
                    "simplified_span": "Harold, who was the most powerful man in England",
                    "explanation": "The simplified text changes the emphasis from Harold's family being powerful to Harold himself being the most powerful man, which is a distortion of the original meaning.",
                    "suggested_fix": "Rephrase to 'Harold, who was the head of the most powerful family in England,' to maintain the original emphasis on the family's power."
                },
                {
                    "type": "meaning",
                    "original_span": "Harold was himself defeated and killed the following month by William the Conqueror at the Battle of Hastings.",
                    "simplified_span": "But the next month, Harold himself was killed by William the Conqueror in the Battle of Hastings.",
                    "explanation": "The simplified text omits the fact that Harold was defeated before being killed, which is an important detail about the Battle of Hastings.",
                    "suggested_fix": "Include 'defeated and' before 'killed' to accurately reflect the sequence of events."
                },
                {
                    "type": "meaning",
                    "original_span": "almost monopolising the English earldoms",
                    "simplified_span": "controlled most of the important positions in England",
                    "explanation": "The simplified text generalizes the specific detail about the Godwin family's dominance over the English earldoms, which is a significant aspect of their power.",
                    "suggested_fix": "Rephrase to 'controlled most of the English earldoms' to retain the specific detail about their influence."
                },
                {
                    "type": "meaning",
                    "original_span": "A few genealogists and historians argue that he was descended from Alfred the Great's elder brother, King \u00c6thelred I (865\u201371), but almost all historians of Anglo-Saxon England reject this theory.",
                    "simplified_span": "Some people think Godwin was related to King Alfred the Great's older brother, but most experts don't believe this.",
                    "explanation": "The simplified text omits the specific names and dates associated with King \u00c6thelred I, which are important for historical context.",
                    "suggested_fix": "Include 'King \u00c6thelred I (865\u201371)' to provide the necessary historical context."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "We don't know much about the family history of Harold II, the last Anglo-Saxon king of England.",
                    "explanation": "The sentence introduces Harold II without providing any context or explanation about his significance or the time period.",
                    "suggested_fix": "Harold II, the last Anglo-Saxon king of England, has a family history that remains largely unknown."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Harold, who was the most powerful man in England and Edward's brother-in-law, became king instead.",
                    "explanation": "The sentence contains multiple clauses that could be simplified for clarity.",
                    "suggested_fix": "Harold, Edward's brother-in-law and the most powerful man in England, became king instead."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Harold's family is named after his father, Earl Godwin.",
                    "explanation": "The sentence is slightly awkward and could be rephrased for better fluency.",
                    "suggested_fix": "Harold's family took their name from his father, Earl Godwin."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Godwin became rich and powerful in the 1020s under the Danish King Cnut.",
                    "explanation": "The sentence could benefit from a clearer logical connector to explain the relationship between Godwin's rise and King Cnut.",
                    "suggested_fix": "Godwin became rich and powerful in the 1020s, serving under the Danish King Cnut."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "We're not sure about Godwin's background.",
                    "explanation": "The sentence is vague and lacks specificity about what is uncertain regarding Godwin's background.",
                    "suggested_fix": "Details about Godwin's background remain uncertain."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Some people think Godwin was related to King Alfred the Great's older brother, but most experts don't believe this.",
                    "explanation": "The sentence presents a contradiction without a clear explanation of why experts disagree.",
                    "suggested_fix": "Some people speculate that Godwin was related to King Alfred the Great's older brother, though most experts dispute this claim due to lack of evidence."
                }
            ]
        }
    },
    {
        "title": "Ancestry of the Godwins",
        "model_id": "openai_editor",
        "original": "Very little is known for certain of the ancestry of the Godwins, the family of the last Anglo-Saxon king of England, Harold II. When King Edward the Confessor died in January 1066 his closest relative was his great-nephew, Edgar the \u00c6theling, but he was young and lacked powerful supporters. Harold was the head of the most powerful family in England and Edward's brother-in-law, and he became king. In September 1066 Harold defeated and killed King Harald Hardrada of Norway at the Battle of Stamford Bridge, and Harold was himself defeated and killed the following month by William the Conqueror at the Battle of Hastings.\nThe family is named after Harold's father, Earl Godwin, who had risen to a position of wealth and influence in the 1020s under Danish King Cnut the Great. In 1045 Godwin's daughter, Edith, married King Edward the Confessor, and by the mid-1050s Harold and his brothers had become dominant, almost monopolising the English earldoms. Godwin's origin is obscure. He was probably the son of Wulfnoth Cild, a South Saxon thegn, but Wulfnoth's ancestry is disputed. A few genealogists and historians argue that he was descended from Alfred the Great's elder brother, King \u00c6thelred I (865\u201371), but almost all historians of Anglo-Saxon England reject this theory.",
        "simplified": "We don't know much about the family history of the Godwins. They were the family of Harold II, the last Anglo-Saxon king of England. When King Edward the Confessor died in January 1066, his closest relative was his great-nephew, Edgar the \u00c6theling. However, Edgar was young and didn't have strong supporters. Harold was the leader of the most powerful family in England and was married to Edward's sister, so he became king. In September 1066, Harold won a battle against King Harald Hardrada of Norway at Stamford Bridge but was killed the next month by William the Conqueror at the Battle of Hastings.\n\nThe family was named after Harold's father, Earl Godwin, who became rich and influential in the 1020s during the reign of the Danish King Cnut the Great. In 1045, Godwin's daughter, Edith, married King Edward the Confessor. By the mid-1050s, Harold and his brothers held most of the important positions in England. Godwin's background is unclear. He was likely the son of Wulfnoth Cild, a noble from South Saxons, but people disagree about Wulfnoth's ancestry. Some genealogists and historians think he was related to King Alfred the Great's older brother, King \u00c6thelred I, but most historians of Anglo-Saxon England do not agree with this idea.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Harold was the head of the most powerful family in England and Edward's brother-in-law, and he became king.",
                    "simplified_span": "Harold was the leader of the most powerful family in England and was married to Edward's sister, so he became king.",
                    "explanation": "The simplified text incorrectly states that Harold was married to Edward's sister, which is not mentioned in the original text. The original text states that Harold was Edward's brother-in-law, which could mean he was married to Edward's sister or that Edward was married to Harold's sister. The latter is correct as per the original text.",
                    "suggested_fix": "Change the simplified text to: 'Harold was the leader of the most powerful family in England and Edward's brother-in-law, so he became king.'"
                },
                {
                    "type": "meaning",
                    "original_span": "almost monopolising the English earldoms",
                    "simplified_span": "held most of the important positions in England",
                    "explanation": "The simplified text loses the nuance of 'almost monopolising,' which implies a near-complete control, whereas 'held most of the important positions' is less strong and specific.",
                    "suggested_fix": "Change the simplified text to: 'almost monopolising the important positions in England.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "We don't know much about the family history of the Godwins.",
                    "explanation": "The sentence is vague and lacks specificity about what is unknown regarding the Godwins' family history.",
                    "suggested_fix": "The details of the Godwins' family history are largely unknown."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Harold was the leader of the most powerful family in England and was married to Edward's sister, so he became king.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "Harold was the leader of the most powerful family in England. He was also married to Edward's sister, which helped him become king."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The family was named after Harold's father, Earl Godwin, who became rich and influential in the 1020s during the reign of the Danish King Cnut the Great.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "The family was named after Harold's father, Earl Godwin. He became rich and influential in the 1020s during the reign of the Danish King Cnut the Great."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Godwin's background is unclear.",
                    "explanation": "The sentence is vague and lacks specificity about what is unclear regarding Godwin's background.",
                    "suggested_fix": "Details about Godwin's background are unclear."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "He was likely the son of Wulfnoth Cild, a noble from South Saxons, but people disagree about Wulfnoth's ancestry.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "He was likely the son of Wulfnoth Cild, a noble from South Saxons. However, there is disagreement about Wulfnoth's ancestry."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Some genealogists and historians think he was related to King Alfred the Great's older brother, King \u00c6thelred I, but most historians of Anglo-Saxon England do not agree with this idea.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "Some genealogists and historians think he was related to King Alfred the Great's older brother, King \u00c6thelred I. However, most historians of Anglo-Saxon England do not agree with this idea."
                }
            ]
        }
    },
    {
        "title": "Ancestry of the Godwins",
        "model_id": "gemma_editor",
        "original": "Very little is known for certain of the ancestry of the Godwins, the family of the last Anglo-Saxon king of England, Harold II. When King Edward the Confessor died in January 1066 his closest relative was his great-nephew, Edgar the \u00c6theling, but he was young and lacked powerful supporters. Harold was the head of the most powerful family in England and Edward's brother-in-law, and he became king. In September 1066 Harold defeated and killed King Harald Hardrada of Norway at the Battle of Stamford Bridge, and Harold was himself defeated and killed the following month by William the Conqueror at the Battle of Hastings.\nThe family is named after Harold's father, Earl Godwin, who had risen to a position of wealth and influence in the 1020s under Danish King Cnut the Great. In 1045 Godwin's daughter, Edith, married King Edward the Confessor, and by the mid-1050s Harold and his brothers had become dominant, almost monopolising the English earldoms. Godwin's origin is obscure. He was probably the son of Wulfnoth Cild, a South Saxon thegn, but Wulfnoth's ancestry is disputed. A few genealogists and historians argue that he was descended from Alfred the Great's elder brother, King \u00c6thelred I (865\u201371), but almost all historians of Anglo-Saxon England reject this theory.",
        "simplified": "We don\u2019t really know much about where the Godwin family came from, which is the family of Harold II, the last Anglo-Saxon king of England. \n\nWhen King Edward died in 1066, his closest relative was his nephew, Edgar the \u00c6theling, but Edgar was young and didn\u2019t have many supporters. Harold Godwin was a very important family leader in England, and he was also Edward\u2019s brother-in-law, so he became king. In September 1066, Harold won a victory against King Harald Hardrada of Norway at the Battle of Stamford Bridge, but he was later defeated and killed by William the Conqueror at the Battle of Hastings the following month.\n\nThe Godwin family\u2019s name comes from Harold\u2019s father, Earl Godwin. Earl Godwin became rich and powerful in the 1020s while serving King Cnut the Great, who was Danish. In 1045, Godwin\u2019s daughter, Edith, married King Edward the Confessor. By the mid-1050s, Harold and his brothers had become the most powerful landowners in England, almost controlling all the earldoms (important regions ruled by earls).\n\nHowever, where Godwin himself came from is unclear. He was likely the son of Wulfnoth Cild, a nobleman from the south of England. But there\u2019s a lot of debate about Wulfnoth\u2019s family history. Some people believe he might be descended from Alfred the Great\u2019s older brother, King \u00c6thelred I, but most historians who study Anglo-Saxon England disagree with this idea.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "his great-nephew, Edgar the \u00c6theling",
                    "simplified_span": "his nephew, Edgar the \u00c6theling",
                    "explanation": "The simplified text incorrectly states that Edgar the \u00c6theling was King Edward's nephew, whereas the original text correctly identifies him as his great-nephew.",
                    "suggested_fix": "Change 'his nephew, Edgar the \u00c6theling' to 'his great-nephew, Edgar the \u00c6theling'."
                },
                {
                    "type": "meaning",
                    "original_span": "Harold was the head of the most powerful family in England",
                    "simplified_span": "Harold Godwin was a very important family leader in England",
                    "explanation": "The simplified text underplays the extent of Harold's power by describing him as a 'very important family leader' rather than the head of the most powerful family in England.",
                    "suggested_fix": "Change 'a very important family leader in England' to 'the head of the most powerful family in England'."
                },
                {
                    "type": "meaning",
                    "original_span": "almost monopolising the English earldoms",
                    "simplified_span": "almost controlling all the earldoms",
                    "explanation": "The simplified text suggests complete control over the earldoms, whereas the original text implies dominance but not absolute control.",
                    "suggested_fix": "Change 'almost controlling all the earldoms' to 'almost monopolising the English earldoms'."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "We don\u2019t really know much about where the Godwin family came from, which is the family of Harold II, the last Anglo-Saxon king of England.",
                    "explanation": "The sentence is long and contains multiple clauses, which can make it difficult to follow.",
                    "suggested_fix": "We don\u2019t really know much about the origins of the Godwin family. This family includes Harold II, the last Anglo-Saxon king of England."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Harold Godwin was a very important family leader in England, and he was also Edward\u2019s brother-in-law, so he became king.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "Harold Godwin was a very important family leader in England. He was also Edward\u2019s brother-in-law, which helped him become king."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Harold won a victory against King Harald Hardrada of Norway at the Battle of Stamford Bridge, but he was later defeated and killed by William the Conqueror at the Battle of Hastings the following month.",
                    "explanation": "The sentence contains multiple events that could be separated for clarity.",
                    "suggested_fix": "Harold won a victory against King Harald Hardrada of Norway at the Battle of Stamford Bridge. However, he was later defeated and killed by William the Conqueror at the Battle of Hastings the following month."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Earl Godwin became rich and powerful in the 1020s while serving King Cnut the Great, who was Danish.",
                    "explanation": "The phrase 'who was Danish' is an interruption that could be integrated more smoothly.",
                    "suggested_fix": "Earl Godwin became rich and powerful in the 1020s while serving the Danish King Cnut the Great."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "But there\u2019s a lot of debate about Wulfnoth\u2019s family history.",
                    "explanation": "The sentence starts with 'But,' which can be informal and abrupt in written text.",
                    "suggested_fix": "However, there\u2019s a lot of debate about Wulfnoth\u2019s family history."
                }
            ]
        }
    }
];
// =======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    if (typeof taskData === 'string' || WEB_APP_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
        document.body.innerHTML = '<h1>Error: Data not injected or Web App URL not set in template.html.</h1>';
        return;
    }

    // --- All variables defined here are shared by the functions below ---
    const sourcePanel = document.getElementById('source-panel');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const submitContainer = document.getElementById('submit-button-container');
    let prolificId = '';
    
    // Shuffle the data first, so we can define the original text based on the first item.
    shuffleArray(taskData);
    const originalSourceHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;


    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }


    function buildInterface() {
        const urlParams = new URLSearchParams(window.location.search);
        prolificId = urlParams.get('PROLIFIC_PID') || 'PROLIFIC_ID_NOT_FOUND';

        // --- NEW: Shuffle the taskData array right after it's loaded ---
        shuffleArray(taskData);
        
        sourcePanel.innerHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;
        
        let tabsHTML = '<button type="button" class="tab-button active" data-tab="instructions">Instructions</button>';
        taskData.forEach((_, i) => { tabsHTML += `<button type="button" class="tab-button" data-tab="s${i}">Version ${i + 1}</button>`; });
        tabsHTML += '<button type="button" class="tab-button" data-tab="comparison">Final Comparison</button>';
        tabsContainer.innerHTML = tabsHTML;

        let contentHTML = `<div id="instructions" class="tab-content active"><h3>Instructions</h3><p>Please evaluate each simplification by proceeding through the tabs. Within each tab, use the 'Next' and 'Previous' buttons to move through the evaluation pages.</p></div>`;
        taskData.forEach((simp, i) => { contentHTML += generateSimplificationTabHTML(simp, i); });
        contentHTML += generateFinalComparisonHTML(taskData);
        contentContainer.innerHTML = contentHTML;

        initializeInteractivity();
    }

    function generateSimplificationTabHTML(simplification, simpIndex) {
        const pages = [];
        const escapeRegExp = (string) => string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
        const createRadioOption = (name, value, labelText, tooltipText) => `<label class="radio-option-label"><input type="radio" name="${name}" value="${value}"> ${labelText} <span class="tooltip-container">i<span class="tooltip-text">${tooltipText}</span></span></label>`;
        
        const overallQuestionsHTML = simplification.evaluation.overall_questions.map(q => {
            const labelParts = q.label.split(/:(.*)/s);
            const mainLabel = labelParts[0] + ':';
            const description = labelParts[1] || '';
            const optionsHTML = q.options.map(opt => createRadioOption(`s${simpIndex}_${q.key}`, opt.label, opt.label, opt.description)).join('');
            return `<div class="question-block"><label>${mainLabel}<span class="question-description">${description}</span></label>${optionsHTML}</div>`;
        }).join('');
        pages.push({type: 'overall', content: `<h3>Overall Quality Questions</h3><div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>${overallQuestionsHTML}` });

        simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
            const highlightedSimplified = issue.simplified_span ? simplification.simplified.replace(new RegExp(escapeRegExp(issue.simplified_span), 'g'), `<mark>${issue.simplified_span}</mark>`) : simplification.simplified;
            let contextHTML = `<div class="context-sub-header"></div><p>${highlightedSimplified.replace(/\n/g, '<br>')}</p>`;
            const severityOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Major", "Major Issue", "Significantly harms comprehension or quality.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Minor", "Minor Issue", "Small issue that could be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Not an issue", "No Issue", "The text is acceptable as is.");
            const explanationOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Correct", "Correct", "Identifies and describes the main issue.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Partially Correct", "Partially Correct", "Identifies a real issue, but the explanation is incomplete or inaccurate.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Incorrect", "Incorrect", "Describes a problem that doesn't actually exist.");
            const fixOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Solves the issue", "Solves", "This is a clear and successful improvement.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Partial improvement", "Partial", "The fix is slightly better, but the text could still be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "No difference", "No Difference", "The fix is neither better nor worse than the original text.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Worse", "Worse", "The suggested fix is actually a regression.");
            pages.push({type: issue.type, originalSpan: issue.original_span, content: `<h3>Span Evaluation (${issueIndex + 1}/${simplification.evaluation.simplicity_issues.length})</h3><div class="wizard-context-header">${contextHTML}</div><div class="question-block"><p><strong>Explanation:</strong> ${issue.explanation}</p><p><strong>Suggested Fix:</strong> <span style="color:#28a745;">${issue.suggested_fix}</span></p></div><div class="question-block"><label>How would you rate this issue?</label>${severityOptions}</div><div class="question-block"><label>How accurate is the LLM's explanation?</label>${explanationOptions}</div><div class="question-block"><label>Is the suggested fix an improvement?</label>${fixOptions}</div>`});
        });
        
        pages.push({
            type: 'feedback',
            content: `<h3>Additional Feedback</h3>
                    <div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>
                    <div class="question-block">
                        <label>Did you notice any other issues while reading that were not highlighted? If so, please paste relevant spans here or describe them below.</label>
                        <textarea name="s${simpIndex}_missed_issues_text" class="missed-issues-textarea" data-simp-index="${simpIndex}" rows="5" style="width: 95%; padding: 5px;"></textarea>
                        <div style="margin-top: 10px;"><label><input type="checkbox" name="s${simpIndex}_missed_issues_none" class="missed-issues-none-checkbox" data-simp-index="${simpIndex}" value="None"> I did not notice any other issues.</label></div>
                    </div>`
        });
        const wizardPagesHTML = pages.map((page, pageIndex) => `<div class="wizard-page" data-page-index="${pageIndex}" data-issue-type="${page.type}" data-original-span="${page.originalSpan || ''}">${page.content}<div class="wizard-nav"><button type="button" class="wizard-nav-button prev" style="visibility: ${pageIndex > 0 ? 'visible' : 'hidden'};">&laquo; Previous</button><span>Page ${pageIndex + 1} of ${pages.length}</span><button type="button" class="wizard-nav-button next" style="visibility: ${pageIndex < pages.length - 1 ? 'visible' : 'hidden'};">Next &raquo;</button></div></div>`).join('');
        return `<div id="s${simpIndex}" class="tab-content wizard-container">${wizardPagesHTML}</div>`;
    }
    
    function generateFinalComparisonHTML(data) {
        let optionsHTML = data.map((task, i) => `<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="${task.model_id}"> Version ${i+1}</label>`).join('');
        return `<div id="comparison" class="tab-content"><h3>Final Comparison</h3><div class="question-block"><label>Which simplification was the best overall?</label>${optionsHTML}<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="All Equal"> All were about equal</label></div></div>`;
    }

    function highlightSourceSpan(spanText) {
        sourcePanel.innerHTML = originalSourceHTML;
        
        if (spanText && spanText !== 'null') {
            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const highlightedHTML = originalSourceHTML.replace(
                new RegExp(escapeRegExp(spanText), 'g'),
                `<mark>${spanText}</mark>`
            );
            sourcePanel.innerHTML = highlightedHTML;
        }
    }

    function initializeInteractivity() {
        // --- THIS FUNCTION NOW LIVES INSIDE INITIALIZEINTERACTIVITY ---
        function highlightSourceSpan(spanText) {
            // Always start with the clean, un-highlighted version of the source text
            sourcePanel.innerHTML = originalSourceHTML;
            
            // If there's a span to highlight, find it and wrap it in <mark> tags
            if (spanText && spanText !== 'null') {
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const highlightedHTML = originalSourceHTML.replace(
                    new RegExp(escapeRegExp(spanText), 'g'),
                    `<mark>${spanText}</mark>`
                );
                sourcePanel.innerHTML = highlightedHTML;
            }
        }

        // Tab switching logic
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                if(tabsContainer.querySelector('.active')) tabsContainer.querySelector('.active').classList.remove('active');
                if(contentContainer.querySelector('.tab-content.active')) contentContainer.querySelector('.tab-content.active').classList.remove('active');
                e.target.classList.add('active');
                const newTabContent = contentContainer.querySelector(`#${tabId}`);
                if (newTabContent) newTabContent.classList.add('active');
                submitContainer.style.display = (tabId === 'comparison') ? 'block' : 'none';
                
                highlightSourceSpan(null);
            }
        });

        // Wizard navigation logic
        contentContainer.addEventListener('click', (e) => {
            if (e.target.matches('.wizard-nav-button')) {
                const wizardContainer = e.target.closest('.wizard-container');
                const currentPage = e.target.closest('.wizard-page');
                let currentPageIndex = parseInt(currentPage.dataset.pageIndex, 10);
                currentPageIndex += e.target.matches('.next') ? 1 : -1;
                const newActivePage = wizardContainer.querySelector(`.wizard-page[data-page-index="${currentPageIndex}"]`);
                if (newActivePage) {
                    currentPage.classList.remove('active');
                    newActivePage.classList.add('active');
                    const spanToHighlight = newActivePage.dataset.originalSpan;
                    highlightSourceSpan(spanToHighlight);
                }
            }
        });
        
        document.querySelectorAll('.wizard-container').forEach(container => container.querySelector('.wizard-page')?.classList.add('active'));
        
        document.getElementById('evaluation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting... Please Wait';

            const allFormData = new FormData(document.getElementById('evaluation-form'));
            const allSubmissions = [];

            taskData.forEach((simplification, simpIndex) => {
                const dataToSubmit = {};
                
                dataToSubmit['Prolific ID'] = prolificId;
                dataToSubmit['Document Title'] = simplification.title;
                dataToSubmit['Simplification Model ID'] = simplification.model_id;

                simplification.evaluation.overall_questions.forEach(q => {
                    dataToSubmit[q.label] = allFormData.get(`s${simpIndex}_${q.key}`) || '';
                });

                simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
                    const spanNum = issueIndex + 1;
                    dataToSubmit[`Span ${spanNum} Text`] = issue.simplified_span || 'SPAN_NOT_FOUND';
                    dataToSubmit[`Span ${spanNum} - Issue Severity`] = allFormData.get(`s${simpIndex}_span${issueIndex}_severity`) || '';
                    dataToSubmit[`Span ${spanNum} - Explanation Accuracy`] = allFormData.get(`s${simpIndex}_span${issueIndex}_explanation`) || '';
                    dataToSubmit[`Span ${spanNum} - Fix Improvement`] = allFormData.get(`s${simpIndex}_span${issueIndex}_fix`) || '';
                });

                const missedIssuesText = allFormData.get(`s${simpIndex}_missed_issues_text`);
                const isNoneChecked = allFormData.get(`s${simpIndex}_missed_issues_none`);
                dataToSubmit['Missed Issues Text'] = isNoneChecked ? 'None' : missedIssuesText || '';
                dataToSubmit['No Missed Issues Found'] = isNoneChecked ? 'Checked' : '';
                
                if (simpIndex === taskData.length - 1) {
                    dataToSubmit['Final Comparison Choice'] = allFormData.get('final_choice') || '';
                }
                
                allSubmissions.push(dataToSubmit);
            });

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(allSubmissions),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === 'success') {
                    window.location.href = PROLIFIC_COMPLETION_URL;
                } else {
                    throw new Error(data.message || 'The script reported an unknown error.');
                }
            })
            .catch(error => {
                console.error("A critical error occurred during submission:", error);
                alert("A submission error occurred. Your responses could not be saved. Please contact the researcher.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit All Evaluations';
            });
        });
    }
    buildInterface();
});
</script>

</body>
</html>