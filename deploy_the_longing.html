<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Evaluation Workbench</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .workbench-container { display: flex; flex-direction: column; height: 100vh; }
        .workbench-header { padding: 10px 20px; background-color: #fff; border-bottom: 2px solid #dee4e9; text-align: center; flex-shrink: 0; }
        .workbench-body { display: flex; flex-grow: 1; overflow: hidden; }
        .source-panel { flex: 0 0 35%; padding: 20px; background-color: #e9eef2; border-right: 2px solid #dee4e9; overflow-y: auto; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #dee4e9; background-color: #fdfdfd; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { font-weight: bold; color: #0056b3; border-bottom: 3px solid #0056b3; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .wizard-page { display: none; margin-bottom: 20px; }
        .wizard-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-context-header { padding: 15px; background-color: #fff; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        .wizard-nav { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wizard-nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; }
        .question-block { margin: 25px 0; border-left: 3px solid #007bff; padding-left: 15px;}
        .question-block label { font-weight: bold; display: block; margin-bottom: 8px; }
        .radio-option-label { display: block; margin-bottom: 5px; }
        #submit-button-container { display: none; text-align: center; padding: 30px; }
        #submit-button { padding: 15px 25px; background-color: #28a745; color: white; border-radius: 8px; font-size: 20px; font-weight: bold; border: none; cursor: pointer; }
        #submit-button:disabled { background-color: #999; }
        mark { background-color: #ffeb3b; padding: 2px 0; border-radius: 3px; }
        .tooltip-container { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 1px solid #0056b3; border-radius: 50%; font-size: 10px; font-weight: bold; color: #0056b3; margin-left: 8px; position: relative; cursor: help; vertical-align: middle; }
        .tooltip-text { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 150%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-weight: normal; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .question-description { font-weight: normal; color: #555; margin-left: 6px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="workbench-container">
    <div class="workbench-header"><h1 id="study-title">Document Simplification Evaluation</h1></div>
    <form id="evaluation-form">
        <div class="workbench-body">
            <aside id="source-panel" class="source-panel"></aside>
            <main class="main-panel">
                <div id="tabs-container" class="tabs"></div>
                <div id="content-container"></div>
                <div id="submit-button-container">
                    <button type="submit" id="submit-button">Submit All Evaluations</button>
                </div>
            </main>
        </div>
    </form>
</div>

<script>
// =======================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLJNvnP5Z1vW1w3MxaLygN-1b7aBU5DRM30i7w3LFRFNXt6AoC7FDgoovhTOEsYWAQ/exec';
const PROLIFIC_COMPLETION_URL = 'https://app.prolific.com/submissions/complete?cc=C10POQX1';
// =======================================================================
// === DATA INJECTION POINT (These will be replaced by Python) ===
const taskData = [
    {
        "title": "The Longing",
        "model_id": "claude_editor",
        "original": "The Longing is a 2020 point-and-click adventure game created by independent developer Studio Seufz. Set in an underground kingdom, the player controls the Shade, a creature tasked with watching over a sleeping king for 400 days. The Shade performs recreational activities, including reading and exploring, as it waits out the 400 days in real time. The in-game timer continues regardless of the player's actions but moves faster if the Shade performs certain actions inside its home, such as decorating the walls with drawings.\nDeveloper Anselm Pyta conceived of The Longing after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave. Pyta sought to explore emotional themes in a narrative-driven story and used time as a game mechanism. The developer was inspired by dungeon synth music, which helped him define the subterranean atmosphere and theme of loneliness. Pyta acted as the primary developer for most of the game's six-year production, having to rely upon personal intuition to design the pacing due to playtesting difficulties.\nThe Longing was first released for Windows, macOS, and Linux on March 5, 2020. It gained praise for its soundtrack, visuals, and experimental nature, but the slow-paced gameplay divided critics. The game was released during the COVID-19 pandemic, and many commentators compared it to life under quarantine. The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.\n\n",
        "simplified": "The Longing is a 2020 computer game made by a small team called Studio Seufz. In the game, you control a character called the Shade who lives underground. The Shade's job is to watch over a sleeping king for 400 real-life days. While waiting, the Shade can do things like read books and explore. The game's timer keeps going even when you're not playing, but it goes faster if the Shade does certain things at home, like drawing on the walls.\n\nThe game's creator, Anselm Pyta, got the idea from an old German story he heard while visiting a cave. He wanted to make a game about feelings and use time as part of how the game works. He was inspired by a type of music called dungeon synth, which helped him create the underground feeling and sense of being alone in the game. Pyta worked mostly by himself for six years to make the game. It was hard to test the game because it takes so long to play.\n\nThe Longing came out on March 5, 2020, for Windows, Mac, and Linux computers. People liked the game's music, how it looked, and how different it was. However, some people didn't like how slow the game was. The game came out during the COVID-19 pandemic, and many people compared it to living in lockdown. The Longing was nominated for an award at a game festival and won a prize for being the best first game from a new developer in Germany.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "The Longing is a 2020 point-and-click adventure game",
                    "simplified_span": "The Longing is a 2020 computer game",
                    "explanation": "The simplified text omits the specific genre of the game, 'point-and-click adventure,' which is an important detail about the nature of the gameplay.",
                    "suggested_fix": "The Longing is a 2020 point-and-click computer game"
                },
                {
                    "type": "meaning",
                    "original_span": "Developer Anselm Pyta conceived of The Longing after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave.",
                    "simplified_span": "The game's creator, Anselm Pyta, got the idea from an old German story he heard while visiting a cave.",
                    "explanation": "The simplified text omits the specific name of the legend, 'Kyffh\u00e4user,' and the specific location, 'Barbarossa Cave,' which are important cultural and contextual details.",
                    "suggested_fix": "The game's creator, Anselm Pyta, got the idea from the Kyffh\u00e4user legend he heard while visiting the Barbarossa Cave."
                },
                {
                    "type": "meaning",
                    "original_span": "Pyta acted as the primary developer for most of the game's six-year production, having to rely upon personal intuition to design the pacing due to playtesting difficulties.",
                    "simplified_span": "Pyta worked mostly by himself for six years to make the game. It was hard to test the game because it takes so long to play.",
                    "explanation": "The simplified text changes the emphasis from Pyta's reliance on personal intuition due to playtesting difficulties to a general statement about the difficulty of testing the game.",
                    "suggested_fix": "Pyta worked mostly by himself for six years to make the game, relying on his intuition to design the pacing because it was hard to test due to the game's length."
                },
                {
                    "type": "meaning",
                    "original_span": "The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival",
                    "simplified_span": "The Longing was nominated for an award at a game festival",
                    "explanation": "The simplified text omits the specific award, 'Nuovo Award,' and the name of the festival, '2020 Independent Games Festival,' which are important details about the recognition the game received.",
                    "suggested_fix": "The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The game's timer keeps going even when you're not playing, but it goes faster if the Shade does certain things at home, like drawing on the walls.",
                    "explanation": "The sentence contains multiple clauses and ideas, which can make it harder to follow.",
                    "suggested_fix": "The game's timer keeps going even when you're not playing. However, it speeds up if the Shade does certain activities at home, such as drawing on the walls."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "He wanted to make a game about feelings and use time as part of how the game works.",
                    "explanation": "The phrase 'use time as part of how the game works' is somewhat abstract and could be clearer.",
                    "suggested_fix": "He wanted to make a game about feelings and incorporate the passage of time into the gameplay."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Pyta worked mostly by himself for six years to make the game.",
                    "explanation": "The sentence could be more fluid with a slight rephrasing.",
                    "suggested_fix": "Pyta spent six years mostly working alone to create the game."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "It was hard to test the game because it takes so long to play.",
                    "explanation": "The sentence could be more fluid with a slight rephrasing.",
                    "suggested_fix": "Testing the game was challenging due to its lengthy playtime."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The Longing was nominated for an award at a game festival and won a prize for being the best first game from a new developer in Germany.",
                    "explanation": "The sentence contains multiple ideas that could be separated for clarity.",
                    "suggested_fix": "The Longing was nominated for an award at a game festival. It also won a prize for being the best first game from a new developer in Germany."
                }
            ]
        }
    },
    {
        "title": "The Longing",
        "model_id": "openai_editor",
        "original": "The Longing is a 2020 point-and-click adventure game created by independent developer Studio Seufz. Set in an underground kingdom, the player controls the Shade, a creature tasked with watching over a sleeping king for 400 days. The Shade performs recreational activities, including reading and exploring, as it waits out the 400 days in real time. The in-game timer continues regardless of the player's actions but moves faster if the Shade performs certain actions inside its home, such as decorating the walls with drawings.\nDeveloper Anselm Pyta conceived of The Longing after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave. Pyta sought to explore emotional themes in a narrative-driven story and used time as a game mechanism. The developer was inspired by dungeon synth music, which helped him define the subterranean atmosphere and theme of loneliness. Pyta acted as the primary developer for most of the game's six-year production, having to rely upon personal intuition to design the pacing due to playtesting difficulties.\nThe Longing was first released for Windows, macOS, and Linux on March 5, 2020. It gained praise for its soundtrack, visuals, and experimental nature, but the slow-paced gameplay divided critics. The game was released during the COVID-19 pandemic, and many commentators compared it to life under quarantine. The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.\n\n",
        "simplified": "\"The Longing\" is a point-and-click adventure game from 2020 made by an independent group called Studio Seufz. The game takes place in an underground kingdom where you control a character called the Shade. The Shade has to watch over a king who is sleeping for 400 days. During this time, the Shade can do things like reading or exploring while waiting for the 400 days to pass. The real-time clock in the game keeps going no matter what, but it can speed up if the Shade does specific activities at home, like decorating walls with drawings.\n\nAnselm Pyta, the developer, got the idea for \"The Longing\" after learning about the Kyffh\u00e4user legend during a visit to the Barbarossa Cave. Pyta wanted to explore feelings in a story-driven game and used the concept of time as a key part of the game. He found inspiration in a type of music called dungeon synth, which helped him create the underground setting and feelings of loneliness. Pyta was the main person working on the game for most of the six years it took to make, having to trust his own instincts to set the game's pace due to challenges in testing it with players.\n\n\"The Longing\" was released on March 5, 2020, for Windows, macOS, and Linux. It was praised for its music, look, and unique ideas, but critics had mixed feelings about its slow gameplay. The release happened during the COVID-19 pandemic, which led many to compare the game to living in quarantine. \"The Longing\" was a finalist for a special award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "The Longing is a 2020 point-and-click adventure game created by independent developer Studio Seufz.",
                    "simplified_span": "\"The Longing\" is a point-and-click adventure game from 2020 made by an independent group called Studio Seufz.",
                    "explanation": "The original text specifies that Studio Seufz is an independent developer, whereas the simplified text refers to it as an independent group. This could imply a collective or team rather than a single developer, which slightly alters the understanding of the development process.",
                    "suggested_fix": "Change 'independent group' to 'independent developer' to accurately reflect the original text."
                },
                {
                    "type": "meaning",
                    "original_span": "The in-game timer continues regardless of the player's actions but moves faster if the Shade performs certain actions inside its home, such as decorating the walls with drawings.",
                    "simplified_span": "The real-time clock in the game keeps going no matter what, but it can speed up if the Shade does specific activities at home, like decorating walls with drawings.",
                    "explanation": "The original text specifies that the timer moves faster if the Shade performs certain actions inside its home, implying a specific condition. The simplified text uses 'can speed up,' which suggests a possibility rather than a certainty.",
                    "suggested_fix": "Change 'can speed up' to 'moves faster' to match the certainty expressed in the original text."
                },
                {
                    "type": "meaning",
                    "original_span": "The Longing was first released for Windows, macOS, and Linux on March 5, 2020.",
                    "simplified_span": "\"The Longing\" was released on March 5, 2020, for Windows, macOS, and Linux.",
                    "explanation": "The original text specifies that the game was 'first released' on this date, which implies there may have been subsequent releases or updates. The simplified text omits 'first,' which could lead to the misunderstanding that this was the only release.",
                    "suggested_fix": "Add 'first' before 'released' to preserve the implication of potential subsequent releases."
                },
                {
                    "type": "meaning",
                    "original_span": "The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.",
                    "simplified_span": "\"The Longing\" was a finalist for a special award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.",
                    "explanation": "The original text specifies the name of the award, 'Nuovo Award,' while the simplified text refers to it as 'a special award,' which omits the specific name and could lead to confusion about which award it was.",
                    "suggested_fix": "Replace 'a special award' with 'the Nuovo Award' to accurately reflect the original text."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Anselm Pyta, the developer, got the idea for \"The Longing\" after learning about the Kyffh\u00e4user legend during a visit to the Barbarossa Cave.",
                    "explanation": "The mention of the 'Kyffh\u00e4user legend' and 'Barbarossa Cave' introduces concepts that may not be familiar to all readers, and they are not explained in the text.",
                    "suggested_fix": "Anselm Pyta, the developer, got the idea for \"The Longing\" after learning about the Kyffh\u00e4user legend, a German myth about an emperor sleeping in a mountain, during a visit to the Barbarossa Cave."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Pyta wanted to explore feelings in a story-driven game and used the concept of time as a key part of the game.",
                    "explanation": "The phrase 'explore feelings in a story-driven game' is somewhat abstract and could be made more specific to clarify what is meant.",
                    "suggested_fix": "Pyta wanted to delve into emotions such as loneliness and anticipation in a story-driven game and used the concept of time as a key part of the gameplay."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Pyta was the main person working on the game for most of the six years it took to make, having to trust his own instincts to set the game's pace due to challenges in testing it with players.",
                    "explanation": "This sentence is long and contains multiple clauses, which can make it difficult to follow.",
                    "suggested_fix": "Pyta was the main person working on the game for most of the six years it took to make. He had to trust his own instincts to set the game's pace because testing it with players was challenging."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "The release happened during the COVID-19 pandemic, which led many to compare the game to living in quarantine.",
                    "explanation": "The transition from discussing the game's release to the comparison with quarantine is abrupt and could benefit from a clearer connection.",
                    "suggested_fix": "The release happened during the COVID-19 pandemic, a time when many people were experiencing isolation. This led many to compare the game to living in quarantine."
                }
            ]
        }
    },
    {
        "title": "The Longing",
        "model_id": "gemma_editor",
        "original": "The Longing is a 2020 point-and-click adventure game created by independent developer Studio Seufz. Set in an underground kingdom, the player controls the Shade, a creature tasked with watching over a sleeping king for 400 days. The Shade performs recreational activities, including reading and exploring, as it waits out the 400 days in real time. The in-game timer continues regardless of the player's actions but moves faster if the Shade performs certain actions inside its home, such as decorating the walls with drawings.\nDeveloper Anselm Pyta conceived of The Longing after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave. Pyta sought to explore emotional themes in a narrative-driven story and used time as a game mechanism. The developer was inspired by dungeon synth music, which helped him define the subterranean atmosphere and theme of loneliness. Pyta acted as the primary developer for most of the game's six-year production, having to rely upon personal intuition to design the pacing due to playtesting difficulties.\nThe Longing was first released for Windows, macOS, and Linux on March 5, 2020. It gained praise for its soundtrack, visuals, and experimental nature, but the slow-paced gameplay divided critics. The game was released during the COVID-19 pandemic, and many commentators compared it to life under quarantine. The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the \"Best Debut\" award at the 2020 Deutscher Computerspielpreis.\n\n",
        "simplified": "\u201cThe Longing\u201d is a computer game that came out in 2020 and was made by a small team called Studio Seufz. It\u2019s a puzzle game where you play as a shadowy creature named the Shade. The Shade has to watch over a sleeping king for 400 days, and you do this by exploring a hidden underground kingdom. You can do things like read books and look around, and the game\u2019s clock keeps ticking, even if you\u2019re not doing anything. However, if you do certain activities in your home, like drawing on the walls, the clock goes faster.\n\nThe game\u2019s creator, Anselm Pyta, got the idea after hearing a story about a legendary figure in a cave. He wanted to make a game that felt emotional and told a story, and he used the idea of time as a key part of the game. He was also inspired by a type of music called \u201cdungeon synth,\u201d which helped him create a feeling of being alone underground. Pyta worked on the game for six years mostly by himself, and it was tricky to figure out how fast the game should go because it was hard to get feedback from playtesters.\n\nThe game was first released on computers running Windows, Mac, and Linux on March 5, 2020. People who played it liked the music and the way it looked, and they thought it was a unique game. However, some critics said it was too slow. It came out during the time when many people were stuck at home because of the COVID-19 pandemic, and some people compared that experience to playing the game. \u201cThe Longing\u201d was even nominated for an award at a game festival and won an award for being a great new game in 2020.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "The Longing is a 2020 point-and-click adventure game",
                    "simplified_span": "It\u2019s a puzzle game",
                    "explanation": "The original text specifies that 'The Longing' is a point-and-click adventure game, which is a specific genre. The simplified text describes it as a 'puzzle game,' which is a broader category and may not accurately represent the game's genre.",
                    "suggested_fix": "Change 'It\u2019s a puzzle game' to 'It\u2019s a point-and-click adventure game'"
                },
                {
                    "type": "meaning",
                    "original_span": "Developer Anselm Pyta conceived of The Longing after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave.",
                    "simplified_span": "The game\u2019s creator, Anselm Pyta, got the idea after hearing a story about a legendary figure in a cave.",
                    "explanation": "The simplified text omits the specific reference to the 'Kyffh\u00e4user legend' and 'Barbarossa Cave,' which are important details that provide context for the inspiration behind the game.",
                    "suggested_fix": "Include the specific details: 'The game\u2019s creator, Anselm Pyta, got the idea after hearing the Kyffh\u00e4user legend while visiting the Barbarossa Cave.'"
                },
                {
                    "type": "meaning",
                    "original_span": "The developer was inspired by dungeon synth music, which helped him define the subterranean atmosphere and theme of loneliness.",
                    "simplified_span": "He was also inspired by a type of music called \u201cdungeon synth,\u201d which helped him create a feeling of being alone underground.",
                    "explanation": "The simplified text captures the inspiration from 'dungeon synth' music but does not fully convey that it helped define both the 'subterranean atmosphere' and the 'theme of loneliness.'",
                    "suggested_fix": "Revise to: 'He was also inspired by a type of music called \u201cdungeon synth,\u201d which helped him define the subterranean atmosphere and the theme of loneliness.'"
                },
                {
                    "type": "meaning",
                    "original_span": "The Longing was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the 'Best Debut' award at the 2020 Deutscher Computerspielpreis.",
                    "simplified_span": "\u201cThe Longing\u201d was even nominated for an award at a game festival and won an award for being a great new game in 2020.",
                    "explanation": "The simplified text omits the specific names of the awards and festivals, which are important details that highlight the game's recognition in the industry.",
                    "suggested_fix": "Include the specific award names: '\u201cThe Longing\u201d was a finalist for the Nuovo Award at the 2020 Independent Games Festival and won the 'Best Debut' award at the 2020 Deutscher Computerspielpreis.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "a small team called Studio Seufz",
                    "explanation": "The phrase 'a small team called Studio Seufz' could be simplified for clarity.",
                    "suggested_fix": "a small team named Studio Seufz"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "a shadowy creature named the Shade",
                    "explanation": "The phrase 'a shadowy creature named the Shade' could be simplified for clarity.",
                    "suggested_fix": "a shadowy creature called the Shade"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "the game\u2019s clock keeps ticking, even if you\u2019re not doing anything",
                    "explanation": "The phrase is slightly awkward and could be made more concise.",
                    "suggested_fix": "the game\u2019s clock continues ticking, even when idle"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "if you do certain activities in your home, like drawing on the walls, the clock goes faster",
                    "explanation": "The phrase 'the clock goes faster' is informal and could be more precise.",
                    "suggested_fix": "the clock speeds up"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "a type of music called \u201cdungeon synth,\u201d which helped him create a feeling of being alone underground",
                    "explanation": "The phrase 'a type of music called \u201cdungeon synth,\u201d which helped him create a feeling of being alone underground' is long and could be split for clarity.",
                    "suggested_fix": "a type of music called \u201cdungeon synth.\u201d This music helped him create a feeling of being alone underground."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "it was tricky to figure out how fast the game should go because it was hard to get feedback from playtesters",
                    "explanation": "The phrase 'it was tricky to figure out how fast the game should go because it was hard to get feedback from playtesters' is slightly awkward and could be more concise.",
                    "suggested_fix": "determining the game's speed was challenging due to limited feedback from playtesters"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "People who played it liked the music and the way it looked, and they thought it was a unique game.",
                    "explanation": "The sentence structure is repetitive and could be varied for better flow.",
                    "suggested_fix": "Players appreciated its music, visuals, and uniqueness."
                }
            ]
        }
    }
];
// =======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    if (typeof taskData === 'string' || WEB_APP_URL === 'PASTE_YOUR_WEB_APP_URL_HERE') {
        document.body.innerHTML = '<h1>Error: Data not injected or Web App URL not set in template.html.</h1>';
        return;
    }

    const sourcePanel = document.getElementById('source-panel');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const submitContainer = document.getElementById('submit-button-container');
    let prolificId = '';

    function buildInterface() {
        const urlParams = new URLSearchParams(window.location.search);
        prolificId = urlParams.get('PROLIFIC_PID') || 'PROLIFIC_ID_NOT_FOUND';
        
        sourcePanel.innerHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;
        
        let tabsHTML = '<button type="button" class="tab-button active" data-tab="instructions">Instructions</button>';
        taskData.forEach((_, i) => { tabsHTML += `<button type="button" class="tab-button" data-tab="s${i}">Version ${i + 1}</button>`; });
        tabsHTML += '<button type="button" class="tab-button" data-tab="comparison">Final Comparison</button>';
        tabsContainer.innerHTML = tabsHTML;

        let contentHTML = `<div id="instructions" class="tab-content active"><h3>Instructions</h3><p>Please evaluate each simplification by proceeding through the tabs. Within each tab, use the 'Next' and 'Previous' buttons to move through the evaluation pages.</p></div>`;
        taskData.forEach((simp, i) => { contentHTML += generateSimplificationTabHTML(simp, i); });
        contentHTML += generateFinalComparisonHTML(taskData);
        contentContainer.innerHTML = contentHTML;

        initializeInteractivity();
    }

    function generateSimplificationTabHTML(simplification, simpIndex) {
        const pages = [];
        const escapeRegExp = (string) => string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
        // THIS LINE IS THE ONLY CHANGE: The 'required' keyword has been removed from the input.
        const createRadioOption = (name, value, labelText, tooltipText) => `<label class="radio-option-label"><input type="radio" name="${name}" value="${value}"> ${labelText} <span class="tooltip-container">i<span class="tooltip-text">${tooltipText}</span></span></label>`;
        
        const overallQuestionsHTML = simplification.evaluation.overall_questions.map(q => {
            const labelParts = q.label.split(/:(.*)/s);
            const mainLabel = labelParts[0] + ':';
            const description = labelParts[1] || '';
            const optionsHTML = q.options.map(opt => createRadioOption(`s${simpIndex}_${q.key}`, opt.label, opt.label, opt.description)).join('');
            return `<div class="question-block"><label>${mainLabel}<span class="question-description">${description}</span></label>${optionsHTML}</div>`;
        }).join('');
        pages.push({type: 'overall', content: `<h3>Overall Quality Questions</h3><div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>${overallQuestionsHTML}` });

        simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
            const highlightedSimplified = issue.simplified_span ? simplification.simplified.replace(new RegExp(escapeRegExp(issue.simplified_span), 'g'), `<mark>${issue.simplified_span}</mark>`) : simplification.simplified;
            let contextHTML = `<div class="context-sub-header"></div><p>${highlightedSimplified.replace(/\n/g, '<br>')}</p>`;
            const severityOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Major", "Major Issue", "Significantly harms comprehension or quality.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Minor", "Minor Issue", "Small issue that could be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Not an issue", "No Issue", "The text is acceptable as is.");
            const explanationOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Correct", "Correct", "Identifies and describes the main issue.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Partially Correct", "Partially Correct", "Identifies a real issue, but the explanation is incomplete or inaccurate.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Incorrect", "Incorrect", "Describes a problem that doesn't actually exist.");
            const fixOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Solves the issue", "Solves", "This is a clear and successful improvement.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Partial improvement", "Partial", "The fix is slightly better, but the text could still be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "No difference", "No Difference", "The fix is neither better nor worse than the original text.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Worse", "Worse", "The suggested fix is actually a regression.");
            pages.push({type: issue.type, originalSpan: issue.original_span, content: `<h3>Span Evaluation (${issueIndex + 1}/${simplification.evaluation.simplicity_issues.length})</h3><div class="wizard-context-header">${contextHTML}</div><div class="question-block"><p><strong>Explanation:</strong> ${issue.explanation}</p><p><strong>Suggested Fix:</strong> <span style="color:#28a745;">${issue.suggested_fix}</span></p></div><div class="question-block"><label>How would you rate this issue?</label>${severityOptions}</div><div class="question-block"><label>How accurate is the LLM's explanation?</label>${explanationOptions}</div><div class="question-block"><label>Is the suggested fix an improvement?</label>${fixOptions}</div>`});
        });
        
        pages.push({
            type: 'feedback',
            content: `<h3>Additional Feedback</h3>
                    <div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>
                    <div class="question-block">
                        <label>Did you notice any other issues while reading that were not highlighted? If so, please paste relevant spans here or describe them below.</label>
                        <textarea name="s${simpIndex}_missed_issues_text" class="missed-issues-textarea" data-simp-index="${simpIndex}" rows="5" style="width: 95%; padding: 5px;"></textarea>
                        <div style="margin-top: 10px;"><label><input type="checkbox" name="s${simpIndex}_missed_issues_none" class="missed-issues-none-checkbox" data-simp-index="${simpIndex}" value="None"> I did not notice any other issues.</label></div>
                    </div>`
        });
        const wizardPagesHTML = pages.map((page, pageIndex) => `<div class="wizard-page" data-page-index="${pageIndex}" data-issue-type="${page.type}" data-original-span="${page.originalSpan || ''}">${page.content}<div class="wizard-nav"><button type="button" class="wizard-nav-button prev" style="visibility: ${pageIndex > 0 ? 'visible' : 'hidden'};">&laquo; Previous</button><span>Page ${pageIndex + 1} of ${pages.length}</span><button type="button" class="wizard-nav-button next" style="visibility: ${pageIndex < pages.length - 1 ? 'visible' : 'hidden'};">Next &raquo;</button></div></div>`).join('');
        return `<div id="s${simpIndex}" class="tab-content wizard-container">${wizardPagesHTML}</div>`;
    }
    
    function generateFinalComparisonHTML(data) {
        let optionsHTML = data.map((task, i) => `<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="${task.model_id}"> Version ${i+1}</label>`).join('');
        return `<div id="comparison" class="tab-content"><h3>Final Comparison</h3><div class="question-block"><label>Which simplification was the best overall?</label>${optionsHTML}<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="All Equal"> All were about equal</label></div></div>`;
    }

    function initializeInteractivity() {
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                if(tabsContainer.querySelector('.active')) tabsContainer.querySelector('.active').classList.remove('active');
                if(contentContainer.querySelector('.tab-content.active')) contentContainer.querySelector('.tab-content.active').classList.remove('active');
                e.target.classList.add('active');
                const newTabContent = contentContainer.querySelector(`#${tabId}`);
                if (newTabContent) newTabContent.classList.add('active');
                submitContainer.style.display = (tabId === 'comparison') ? 'block' : 'none';
            }
        });

        contentContainer.addEventListener('click', (e) => {
            if (e.target.matches('.wizard-nav-button')) {
                const wizardContainer = e.target.closest('.wizard-container');
                const currentPage = e.target.closest('.wizard-page');
                let currentPageIndex = parseInt(currentPage.dataset.pageIndex, 10);
                currentPageIndex += e.target.matches('.next') ? 1 : -1;
                currentPage.classList.remove('active');
                wizardContainer.querySelector(`.wizard-page[data-page-index="${currentPageIndex}"]`).classList.add('active');
            }
        });
        
        document.querySelectorAll('.wizard-container').forEach(container => container.querySelector('.wizard-page')?.classList.add('active'));
        
        document.getElementById('evaluation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting... Please Wait';

            const allFormData = new FormData(document.getElementById('evaluation-form'));
            const allSubmissions = [];

            taskData.forEach((simplification, simpIndex) => {
                const dataToSubmit = {};
                
                dataToSubmit['Prolific ID'] = prolificId;
                dataToSubmit['Document Title'] = simplification.title;
                dataToSubmit['Simplification Model ID'] = simplification.model_id;

                simplification.evaluation.overall_questions.forEach(q => {
                    dataToSubmit[q.label] = allFormData.get(`s${simpIndex}_${q.key}`) || '';
                });

                simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
                    const spanNum = issueIndex + 1;
                    dataToSubmit[`Span ${spanNum} Text`] = issue.simplified_span || 'SPAN_NOT_FOUND';
                    dataToSubmit[`Span ${spanNum} - Issue Severity`] = allFormData.get(`s${simpIndex}_span${issueIndex}_severity`) || '';
                    dataToSubmit[`Span ${spanNum} - Explanation Accuracy`] = allFormData.get(`s${simpIndex}_span${issueIndex}_explanation`) || '';
                    dataToSubmit[`Span ${spanNum} - Fix Improvement`] = allFormData.get(`s${simpIndex}_span${issueIndex}_fix`) || '';
                });

                const missedIssuesText = allFormData.get(`s${simpIndex}_missed_issues_text`);
                const isNoneChecked = allFormData.get(`s${simpIndex}_missed_issues_none`);
                dataToSubmit['Missed Issues Text'] = isNoneChecked ? 'None' : missedIssuesText || '';
                dataToSubmit['No Missed Issues Found'] = isNoneChecked ? 'Checked' : '';
                
                if (simpIndex === taskData.length - 1) {
                    dataToSubmit['Final Comparison Choice'] = allFormData.get('final_choice') || '';
                }
                
                allSubmissions.push(dataToSubmit);
            });

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(allSubmissions),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === 'success') {
                    window.location.href = PROLIFIC_COMPLETION_URL;
                } else {
                    throw new Error(data.message || 'The script reported an unknown error.');
                }
            })
            .catch(error => {
                console.error("A critical error occurred during submission:", error);
                alert("A submission error occurred. Your responses could not be saved. Please contact the researcher.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit All Evaluations';
            });
        });
    }

    buildInterface();
});
</script>

</body>
</html>