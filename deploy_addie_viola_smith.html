<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Evaluation Workbench</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; }
        .workbench-container { display: flex; flex-direction: column; height: 100vh; }
        .workbench-header { padding: 10px 20px; background-color: #fff; border-bottom: 2px solid #dee4e9; text-align: center; flex-shrink: 0; }
        .workbench-body { display: flex; flex-grow: 1; overflow: hidden; }
        .source-panel { flex: 0 0 35%; padding: 20px; background-color: #e9eef2; border-right: 2px solid #dee4e9; overflow-y: auto; }
        .main-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 2px solid #dee4e9; background-color: #fdfdfd; padding: 0 20px; flex-shrink: 0; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { font-weight: bold; color: #0056b3; border-bottom: 3px solid #0056b3; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .wizard-page { display: none; margin-bottom: 20px; }
        .wizard-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wizard-context-header { padding: 15px; background-color: #fff; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        .wizard-nav { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .wizard-nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; }
        .question-block { margin: 25px 0; border-left: 3px solid #007bff; padding-left: 15px;}
        .question-block label { font-weight: bold; display: block; margin-bottom: 8px; }
        .radio-option-label { display: block; margin-bottom: 5px; }
        #submit-button-container { display: none; text-align: center; padding: 30px; }
        #submit-button { padding: 15px 25px; background-color: #28a745; color: white; border-radius: 8px; font-size: 20px; font-weight: bold; border: none; cursor: pointer; }
        #submit-button:disabled { background-color: #999; }
        mark { background-color: #ffeb3b; padding: 2px 0; border-radius: 3px; }
        .tooltip-container { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border: 1px solid #0056b3; border-radius: 50%; font-size: 10px; font-weight: bold; color: #0056b3; margin-left: 8px; position: relative; cursor: help; vertical-align: middle; }
        .tooltip-text { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 150%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-weight: normal; }
        .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .question-description { font-weight: normal; color: #555; margin-left: 6px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="workbench-container">
    <div class="workbench-header"><h1 id="study-title">Document Simplification Evaluation</h1></div>
    <form id="evaluation-form">
        <div class="workbench-body">
            <aside id="source-panel" class="source-panel"></aside>
            <main class="main-panel">
                <div id="tabs-container" class="tabs"></div>
                <div id="content-container"></div>
                <div id="submit-button-container">
                    <button type="submit" id="submit-button">Submit All Evaluations</button>
                </div>
            </main>
        </div>
    </form>
</div>

<script>
// =======================================================================
// === DATA INJECTION POINT (These will be replaced by Python) ===
// =======================================================================
const taskData = [
    {
        "title": "Addie Viola Smith",
        "model_id": "claude_editor",
        "original": "Addie Viola Smith (November 14, 1893 \u2013 December 13, 1975), also known as Shi Fanglan (Chinese: \u65bd\u82b3\u862d; pinyin: Sh\u012b F\u0101ngl\u00e1n), was an American attorney who served as the United States trade commissioner to Shanghai from 1928 to 1939. She was the first female Foreign Service officer in the United States Foreign Service to work under the United States Department of Commerce, the first woman to serve as an assistant trade commissioner, and the first woman to serve as trade commissioner.\nSmith was born and raised in Stockton, California. In 1917, she moved to Washington, D.C. While working for the United States Department of Labor, she attended the Washington College of Law part-time, earning her bachelor of laws in 1920. In October that year she joined the Foreign Service and was assigned to Beijing as a clerk in the trade commissioner's office. Smith was promoted to assistant trade commissioner in Shanghai in 1922, and appointed trade commissioner of Shanghai in 1928, a post she held until 1939. For the remainder of her career, she held several roles in the United States government, international organizations, and the United Nations.\nThroughout her life, Smith was also a member of several feminist organizations; scholars have described her international feminist activism as being rooted in imperialist and colonialist attitudes. Smith met her life partner, Eleanor Hinder, in Shanghai in 1926. They lived together until Hinder's death in 1963. Smith died on December 13, 1975, aged 82, in Mosman, New South Wales, and was cremated. She and Hinder were memorialized by their friends with two stone seats at the E.G. Waterhouse National Camellia Gardens in Caringbah.\n\n",
        "simplified": "Addie Viola Smith was an American lawyer who lived from 1893 to 1975. She was also known by her Chinese name, Shi Fanglan. Smith was the first woman to work as a Foreign Service officer for the U.S. Department of Commerce. She was also the first woman to be an assistant trade commissioner and then a trade commissioner.\n\nSmith was born in Stockton, California. In 1917, she moved to Washington, D.C. While working for the U.S. Department of Labor, she studied law part-time and got her law degree in 1920. She then joined the Foreign Service and worked in Beijing as a clerk. In 1922, she was promoted to assistant trade commissioner in Shanghai. In 1928, she became the trade commissioner of Shanghai and held this job until 1939. After that, she worked for the U.S. government, international organizations, and the United Nations.\n\nSmith was involved in women's rights groups. Some scholars say her international feminist work was influenced by imperialist and colonialist ideas. In 1926, Smith met Eleanor Hinder in Shanghai. They became life partners and lived together until Hinder died in 1963.\n\nSmith died on December 13, 1975, at age 82 in Mosman, New South Wales. Her body was cremated. To remember Smith and Hinder, their friends placed two stone seats in the E.G. Waterhouse National Camellia Gardens in Caringbah.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Smith was born and raised in Stockton, California.",
                    "simplified_span": "Smith was born in Stockton, California.",
                    "explanation": "The simplified text omits that Smith was not only born but also raised in Stockton, California. This detail provides additional context about her early life.",
                    "suggested_fix": "Smith was born and raised in Stockton, California."
                },
                {
                    "type": "meaning",
                    "original_span": "Throughout her life, Smith was also a member of several feminist organizations; scholars have described her international feminist activism as being rooted in imperialist and colonialist attitudes.",
                    "simplified_span": "Smith was involved in women's rights groups. Some scholars say her international feminist work was influenced by imperialist and colonialist ideas.",
                    "explanation": "The simplified text changes 'member of several feminist organizations' to 'involved in women's rights groups,' which is less specific and could imply a broader or different type of involvement. Additionally, 'scholars have described' is changed to 'some scholars say,' which softens the assertion.",
                    "suggested_fix": "Smith was a member of several feminist organizations. Scholars have described her international feminist work as being influenced by imperialist and colonialist ideas."
                },
                {
                    "type": "meaning",
                    "original_span": "Smith met her life partner, Eleanor Hinder, in Shanghai in 1926. They lived together until Hinder's death in 1963.",
                    "simplified_span": "In 1926, Smith met Eleanor Hinder in Shanghai. They became life partners and lived together until Hinder died in 1963.",
                    "explanation": "The simplified text changes the order of events, placing the meeting in 1926 before stating they became life partners, which slightly alters the narrative flow.",
                    "suggested_fix": "Smith met her life partner, Eleanor Hinder, in Shanghai in 1926. They lived together until Hinder's death in 1963."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Some scholars say her international feminist work was influenced by imperialist and colonialist ideas.",
                    "explanation": "The sentence introduces the idea that Smith's feminist work was influenced by imperialist and colonialist ideas without providing any context or explanation, which may confuse readers unfamiliar with these concepts.",
                    "suggested_fix": "Some scholars say her international feminist work was influenced by imperialist and colonialist ideas, which suggests that her efforts may have been shaped by the prevailing political and cultural attitudes of the time."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Her body was cremated.",
                    "explanation": "This sentence is abrupt and does not connect well with the preceding sentence about her death, making the transition feel jarring.",
                    "suggested_fix": "After her death, her body was cremated."
                }
            ]
        }
    },
    {
        "title": "Addie Viola Smith",
        "model_id": "openai_editor",
        "original": "Addie Viola Smith (November 14, 1893 \u2013 December 13, 1975), also known as Shi Fanglan (Chinese: \u65bd\u82b3\u862d; pinyin: Sh\u012b F\u0101ngl\u00e1n), was an American attorney who served as the United States trade commissioner to Shanghai from 1928 to 1939. She was the first female Foreign Service officer in the United States Foreign Service to work under the United States Department of Commerce, the first woman to serve as an assistant trade commissioner, and the first woman to serve as trade commissioner.\nSmith was born and raised in Stockton, California. In 1917, she moved to Washington, D.C. While working for the United States Department of Labor, she attended the Washington College of Law part-time, earning her bachelor of laws in 1920. In October that year she joined the Foreign Service and was assigned to Beijing as a clerk in the trade commissioner's office. Smith was promoted to assistant trade commissioner in Shanghai in 1922, and appointed trade commissioner of Shanghai in 1928, a post she held until 1939. For the remainder of her career, she held several roles in the United States government, international organizations, and the United Nations.\nThroughout her life, Smith was also a member of several feminist organizations; scholars have described her international feminist activism as being rooted in imperialist and colonialist attitudes. Smith met her life partner, Eleanor Hinder, in Shanghai in 1926. They lived together until Hinder's death in 1963. Smith died on December 13, 1975, aged 82, in Mosman, New South Wales, and was cremated. She and Hinder were memorialized by their friends with two stone seats at the E.G. Waterhouse National Camellia Gardens in Caringbah.\n\n",
        "simplified": "Addie Viola Smith (November 14, 1893 \u2013 December 13, 1975), also known as Shi Fanglan, was an American lawyer. She was the U.S. trade commissioner in Shanghai from 1928 to 1939. She was the first woman in the U.S. Foreign Service to work for the Department of Commerce, the first female assistant trade commissioner, and the first female trade commissioner.\n\nSmith was born and grew up in Stockton, California. In 1917, she moved to Washington, D.C. While working for the Department of Labor, she went to law school at night and got her law degree in 1920. She joined the Foreign Service in October that year and worked in Beijing as a clerk. She was promoted to assistant trade commissioner in Shanghai in 1922 and then became the trade commissioner in 1928, a job she held until 1939. After that, she worked for the U.S. government, international groups, and the United Nations.\n\nSmith was also part of several women's rights groups. Scholars have said her work in these groups was influenced by imperialist and colonialist views. She met her life partner, Eleanor Hinder, in Shanghai in 1926, and they lived together until Hinder's death in 1963. Smith died at 82 on December 13, 1975, in Mosman, New South Wales, and was cremated. Friends remembered Smith and Hinder by creating two stone seats at the E.G. Waterhouse National Camellia Gardens in Caringbah.",
        "evaluation": {
            "overall_questions": [
                {
                    "key": "fluency",
                    "label": "Fluency: How grammatically correct and well-formed are the sentences?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Many sentences are ungrammatical or nonsensical."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Some sentences are awkward or contain errors."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Mostly fluent, with a few minor awkward phrases."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The text reads naturally with no errors."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The language is exceptionally well-formed and articulate."
                        }
                    ]
                },
                {
                    "key": "clarity",
                    "label": "Clarity: As a stand-alone text, how clear and easy is it to understand the main points?",
                    "options": [
                        {
                            "label": "1 - Very Unclear",
                            "description": "The text is confusing and the main points are hard to grasp."
                        },
                        {
                            "label": "2 - Unclear",
                            "description": "Some parts of the text are confusing or ambiguous."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is generally understandable, but could be clearer."
                        },
                        {
                            "label": "4 - Clear",
                            "description": "The text is easy to understand."
                        },
                        {
                            "label": "5 - Very Clear",
                            "description": "The text is exceptionally easy to follow and unambiguous."
                        }
                    ]
                },
                {
                    "key": "conciseness",
                    "label": "Conciseness: Is the text succinct or does it use unnecessary words?",
                    "options": [
                        {
                            "label": "1 - Very Wordy",
                            "description": "The text is highly repetitive or uses many unnecessary words."
                        },
                        {
                            "label": "2 - Wordy",
                            "description": "The text is somewhat repetitive or wordy."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The text is mostly concise but could be tightened."
                        },
                        {
                            "label": "4 - Concise",
                            "description": "The text is direct and to the point."
                        },
                        {
                            "label": "5 - Very Concise",
                            "description": "Every word serves a clear purpose."
                        }
                    ]
                },
                {
                    "key": "style",
                    "label": "Style: How appropriate and natural is the writing style?",
                    "options": [
                        {
                            "label": "1 - Very Unnatural",
                            "description": "The style feels robotic, 'dumbed down,' or childish."
                        },
                        {
                            "label": "2 - Slightly Unnatural",
                            "description": "The style is a bit simplistic or awkward in places."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "The style is functional but not particularly engaging."
                        },
                        {
                            "label": "4 - Good",
                            "description": "The style is clear, simple, and appropriate for a general audience."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "The style is engaging and perfectly suited for the topic."
                        }
                    ]
                },
                {
                    "key": "overall_impression",
                    "label": "Overall: As a stand-alone piece of writing, what is your overall impression of this text?",
                    "options": [
                        {
                            "label": "1 - Very Poor",
                            "description": "Unacceptable quality, many flaws."
                        },
                        {
                            "label": "2 - Poor",
                            "description": "Has significant flaws that detract from the text."
                        },
                        {
                            "label": "3 - Acceptable",
                            "description": "Generally okay, but with noticeable room for improvement."
                        },
                        {
                            "label": "4 - Good",
                            "description": "Well-written and effective with only minor issues."
                        },
                        {
                            "label": "5 - Excellent",
                            "description": "Exceptionally clear, fluent, and well-written."
                        }
                    ]
                }
            ],
            "simplicity_issues": [
                {
                    "type": "meaning",
                    "original_span": "Throughout her life, Smith was also a member of several feminist organizations; scholars have described her international feminist activism as being rooted in imperialist and colonialist attitudes.",
                    "simplified_span": "Smith was also part of several women's rights groups. Scholars have said her work in these groups was influenced by imperialist and colonialist views.",
                    "explanation": "The original text specifies that Smith's involvement was in 'feminist organizations' and describes her activism as 'international feminist activism,' which is more specific than 'women's rights groups.' The simplified version loses the nuance of 'international feminist activism' and the specific nature of the organizations.",
                    "suggested_fix": "Revise the simplified text to: 'Smith was also part of several feminist organizations. Scholars have said her international feminist activism was influenced by imperialist and colonialist views.'"
                },
                {
                    "type": "meaning",
                    "original_span": "Smith was promoted to assistant trade commissioner in Shanghai in 1922, and appointed trade commissioner of Shanghai in 1928, a post she held until 1939.",
                    "simplified_span": "She was promoted to assistant trade commissioner in Shanghai in 1922 and then became the trade commissioner in 1928, a job she held until 1939.",
                    "explanation": "The original text specifies that Smith was 'appointed trade commissioner of Shanghai,' which emphasizes the formal nature of her appointment. The simplified version uses 'became,' which lacks the same formal connotation.",
                    "suggested_fix": "Revise the simplified text to: 'She was promoted to assistant trade commissioner in Shanghai in 1922 and was appointed as the trade commissioner of Shanghai in 1928, a job she held until 1939.'"
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Scholars have said her work in these groups was influenced by imperialist and colonialist views.",
                    "explanation": "The sentence introduces the idea that Smith's work was influenced by imperialist and colonialist views without providing any context or explanation, which could confuse readers.",
                    "suggested_fix": "Scholars have said her work in these groups was influenced by the prevailing imperialist and colonialist views of the time, which shaped many international policies and attitudes."
                },
                {
                    "type": "writing",
                    "original_span": null,
                    "simplified_span": "Smith died at 82 on December 13, 1975, in Mosman, New South Wales, and was cremated.",
                    "explanation": "The sentence abruptly shifts from discussing Smith's life and achievements to her death and cremation without a smooth transition.",
                    "suggested_fix": "Smith continued to be active in her pursuits until her passing at the age of 82 on December 13, 1975, in Mosman, New South Wales, where she was cremated."
                }
            ]
        }
    }
];
const masterFormBlueprint = {
    "title": "",
    "form_id": "1Y7ehGe00BPog3M7SiE9E-9LihpsMro5bFAZVMW90Xu4",
    "form_response_url": "https://docs.google.com/forms/d/e/1FAIpQLSfndgEdmxHNcyeXG96jNsbDR6JM2N56APmwZJXYcajp1j6uIw/formResponse",
    "entry_ids": {
        "prolific_id": "entry.1641728435",
        "study_task_id": "entry.975413040",
        "document_title": "entry.2019566182",
        "simplification_model_id": "entry.1603047818",
        "fluency": "entry.1023799960",
        "clarity": "entry.2142356029",
        "conciseness": "entry.1596453663",
        "style": "entry.344867456",
        "overall_quality": "entry.1423688542",
        "span_1_text_id": "entry.201589484",
        "span_1_severity_id": "entry.1044641147",
        "span_1_explanation_id": "entry.1621574316",
        "span_1_fix_id": "entry.1716049822",
        "span_2_text_id": "entry.96662513",
        "span_2_severity_id": "entry.1779722240",
        "span_2_explanation_id": "entry.187916775",
        "span_2_fix_id": "entry.1032483144",
        "span_3_text_id": "entry.2045861433",
        "span_3_severity_id": "entry.698569737",
        "span_3_explanation_id": "entry.1175762975",
        "span_3_fix_id": "entry.910158206",
        "span_4_text_id": "entry.1016825185",
        "span_4_severity_id": "entry.1100302845",
        "span_4_explanation_id": "entry.1059456679",
        "span_4_fix_id": "entry.1280218488",
        "span_5_text_id": "entry.1916311038",
        "span_5_severity_id": "entry.456916148",
        "span_5_explanation_id": "entry.79664145",
        "span_5_fix_id": "entry.1032227365",
        "span_6_text_id": "entry.1115969270",
        "span_6_severity_id": "entry.1676635501",
        "span_6_explanation_id": "entry.382979620",
        "span_6_fix_id": "entry.298424575",
        "span_7_text_id": "entry.686604234",
        "span_7_severity_id": "entry.34220767",
        "span_7_explanation_id": "entry.708847223",
        "span_7_fix_id": "entry.795761592",
        "span_8_text_id": "entry.661364923",
        "span_8_severity_id": "entry.236175553",
        "span_8_explanation_id": "entry.1791820985",
        "span_8_fix_id": "entry.298349590",
        "span_9_text_id": "entry.801280874",
        "span_9_severity_id": "entry.621340040",
        "span_9_explanation_id": "entry.611879530",
        "span_9_fix_id": "entry.1412455209",
        "span_10_text_id": "entry.1970544739",
        "span_10_severity_id": "entry.1273737843",
        "span_10_explanation_id": "entry.1432855076",
        "span_10_fix_id": "entry.66010245",
        "span_11_text_id": "entry.488922546",
        "span_11_severity_id": "entry.455007372",
        "span_11_explanation_id": "entry.1979640949",
        "span_11_fix_id": "entry.542534205",
        "span_12_text_id": "entry.2029637668",
        "span_12_severity_id": "entry.289003223",
        "span_12_explanation_id": "entry.1795503236",
        "span_12_fix_id": "entry.1250732562",
        "span_13_text_id": "entry.1575325469",
        "span_13_severity_id": "entry.769477191",
        "span_13_explanation_id": "entry.255232403",
        "span_13_fix_id": "entry.600228383",
        "span_14_text_id": "entry.285926682",
        "span_14_severity_id": "entry.131806950",
        "span_14_explanation_id": "entry.528004049",
        "span_14_fix_id": "entry.1972532563",
        "span_15_text_id": "entry.935686439",
        "span_15_severity_id": "entry.204065219",
        "span_15_explanation_id": "entry.2001532115",
        "span_15_fix_id": "entry.1471999675",
        "span_16_text_id": "entry.1847993664",
        "span_16_severity_id": "entry.967827442",
        "span_16_explanation_id": "entry.522756821",
        "span_16_fix_id": "entry.1000593747",
        "span_17_text_id": "entry.1746977603",
        "span_17_severity_id": "entry.574726844",
        "span_17_explanation_id": "entry.375781308",
        "span_17_fix_id": "entry.369053431",
        "span_18_text_id": "entry.1705432400",
        "span_18_severity_id": "entry.268234303",
        "span_18_explanation_id": "entry.1602721037",
        "span_18_fix_id": "entry.1084936701",
        "span_19_text_id": "entry.1229723836",
        "span_19_severity_id": "entry.250664122",
        "span_19_explanation_id": "entry.1045393847",
        "span_19_fix_id": "entry.2057364682",
        "span_20_text_id": "entry.1245597241",
        "span_20_severity_id": "entry.757759723",
        "span_20_explanation_id": "entry.737109408",
        "span_20_fix_id": "entry.2093806631",
        "missed_issues_text": "entry.617722766",
        "missed_issues_none": "entry.331827870",
        "final_comparison_choice": "entry.842315270"
    },
    "prolificCompletionUrl": "https://app.prolific.com/submissions/complete?cc=C10POQX1"
};
// =======================================================================

document.addEventListener('DOMContentLoaded', function() {
    
    if (typeof taskData === 'string' || typeof masterFormBlueprint === 'string') {
        document.body.innerHTML = '<h1>Error: Data not injected into template. Please run the Python script to generate a survey file.</h1>';
        return;
    }

    const sourcePanel = document.getElementById('source-panel');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const submitContainer = document.getElementById('submit-button-container');
    let prolificId = '';

    function buildInterface() {
        const urlParams = new URLSearchParams(window.location.search);
        prolificId = urlParams.get('PROLIFIC_PID') || 'PROLIFIC_ID_NOT_FOUND';
        
        sourcePanel.innerHTML = `<h2>Source Document</h2><p><strong>Title:</strong> ${taskData[0].title}</p><p>${taskData[0].original.replace(/\n/g, '<br>')}</p>`;
        
        let tabsHTML = '<button type="button" class="tab-button active" data-tab="instructions">Instructions</button>';
        taskData.forEach((_, i) => { tabsHTML += `<button type="button" class="tab-button" data-tab="s${i}">Version ${i + 1}</button>`; });
        tabsHTML += '<button type="button" class="tab-button" data-tab="comparison">Final Comparison</button>';
        tabsContainer.innerHTML = tabsHTML;

        let contentHTML = `<div id="instructions" class="tab-content active"><h3>Instructions</h3><p>Please evaluate each simplification by proceeding through the tabs. Within each tab, use the 'Next' and 'Previous' buttons to move through the evaluation pages.</p></div>`;
        taskData.forEach((simp, i) => { contentHTML += generateSimplificationTabHTML(simp, i); });
        contentHTML += generateFinalComparisonHTML(taskData);
        contentContainer.innerHTML = contentHTML;

        initializeInteractivity();
    }

    function generateSimplificationTabHTML(simplification, simpIndex) {
        const pages = [];
        const escapeRegExp = (string) => string ? string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') : '';
        const createRadioOption = (name, value, labelText, tooltipText) => `<label class="radio-option-label"><input type="radio" name="${name}" value="${value}" required> ${labelText} <span class="tooltip-container">i<span class="tooltip-text">${tooltipText}</span></span></label>`;
        
        const overallQuestionsHTML = simplification.evaluation.overall_questions.map(q => {
            const labelParts = q.label.split(/:(.*)/s);
            const mainLabel = labelParts[0] + ':';
            const description = labelParts[1] || '';
            const optionsHTML = q.options.map(opt => createRadioOption(`s${simpIndex}_${q.key}`, opt.label, opt.label, opt.description)).join('');
            return `<div class="question-block"><label>${mainLabel}<span class="question-description">${description}</span></label>${optionsHTML}</div>`;
        }).join('');
        pages.push({type: 'overall', content: `<h3>Overall Quality Questions</h3><div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>${overallQuestionsHTML}` });

        simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
            const highlightedSimplified = issue.simplified_span ? simplification.simplified.replace(new RegExp(escapeRegExp(issue.simplified_span), 'g'), `<mark>${issue.simplified_span}</mark>`) : simplification.simplified;
            let contextHTML = `<div class="context-sub-header"></div><p>${highlightedSimplified.replace(/\n/g, '<br>')}</p>`;
            const severityOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Major", "Major Issue", "Significantly harms comprehension or quality.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Minor", "Minor Issue", "Small issue that could be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_severity`, "Not an issue", "No Issue", "The text is acceptable as is.");
            const explanationOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Correct", "Correct", "Identifies and describes the main issue.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Partially Correct", "Partially Correct", "Identifies a real issue, but the explanation is incomplete or inaccurate.") + createRadioOption(`s${simpIndex}_span${issueIndex}_explanation`, "Incorrect", "Incorrect", "Describes a problem that doesn't actually exist.");
            const fixOptions = createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Solves the issue", "Solves", "This is a clear and successful improvement.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Partial improvement", "Partial", "The fix is slightly better, but the text could still be improved.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "No difference", "No Difference", "The fix is neither better nor worse than the original text.") + createRadioOption(`s${simpIndex}_span${issueIndex}_fix`, "Worse", "Worse", "The suggested fix is actually a regression.");
            pages.push({type: issue.type, originalSpan: issue.original_span, content: `<h3>Span Evaluation (${issueIndex + 1}/${simplification.evaluation.simplicity_issues.length})</h3><div class="wizard-context-header">${contextHTML}</div><div class="question-block"><p><strong>Explanation:</strong> ${issue.explanation}</p><p><strong>Suggested Fix:</strong> <span style="color:#28a745;">${issue.suggested_fix}</span></p></div><div class="question-block"><label>How would you rate this issue?</label>${severityOptions}</div><div class="question-block"><label>How accurate is the LLM's explanation?</label>${explanationOptions}</div><div class="question-block"><label>Is the suggested fix an improvement?</label>${fixOptions}</div>`});
        });
        
        pages.push({
            type: 'feedback',
            content: `<h3>Additional Feedback</h3>
                    <div class="wizard-context-header"><p>${simplification.simplified.replace(/\n/g, '<br>')}</p></div>
                    <div class="question-block">
                        <label>Did you notice any other issues while reading that were not highlighted? If so, please paste relevant spans here or describe them below.</label>
                        <textarea name="s${simpIndex}_missed_issues_text" class="missed-issues-textarea" data-simp-index="${simpIndex}" rows="5" style="width: 95%; padding: 5px;"></textarea>
                        <div style="margin-top: 10px;"><label><input type="checkbox" name="s${simpIndex}_missed_issues_none" class="missed-issues-none-checkbox" data-simp-index="${simpIndex}" value="None"> I did not notice any other issues.</label></div>
                    </div>`
        });
        const wizardPagesHTML = pages.map((page, pageIndex) => `<div class="wizard-page" data-page-index="${pageIndex}" data-issue-type="${page.type}" data-original-span="${page.originalSpan || ''}">${page.content}<div class="wizard-nav"><button type="button" class="wizard-nav-button prev" style="visibility: ${pageIndex > 0 ? 'visible' : 'hidden'};">&laquo; Previous</button><span>Page ${pageIndex + 1} of ${pages.length}</span><button type="button" class="wizard-nav-button next" style="visibility: ${pageIndex < pages.length - 1 ? 'visible' : 'hidden'};">Next &raquo;</button></div></div>`).join('');
        return `<div id="s${simpIndex}" class="tab-content wizard-container">${wizardPagesHTML}</div>`;
    }
    
    function generateFinalComparisonHTML(data) {
        let optionsHTML = data.map((task, i) => `<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="${task.model_id}" required> Version ${i+1}</label>`).join('');
        return `<div id="comparison" class="tab-content"><h3>Final Comparison</h3><div class="question-block"><label>Which simplification was the best overall?</label>${optionsHTML}<label style="margin-right: 15px;"><input type="radio" name="final_choice" value="All Equal" required> All were about equal</label></div></div>`;
    }

    function initializeInteractivity() {
        // Tab switching logic
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-button')) {
                const tabId = e.target.dataset.tab;
                if(tabsContainer.querySelector('.active')) tabsContainer.querySelector('.active').classList.remove('active');
                if(contentContainer.querySelector('.tab-content.active')) contentContainer.querySelector('.tab-content.active').classList.remove('active');
                e.target.classList.add('active');
                const newTabContent = contentContainer.querySelector(`#${tabId}`);
                if (newTabContent) newTabContent.classList.add('active');
                submitContainer.style.display = (tabId === 'comparison') ? 'block' : 'none';
            }
        });

        // Wizard navigation logic
        contentContainer.addEventListener('click', (e) => {
            if (e.target.matches('.wizard-nav-button')) {
                const wizardContainer = e.target.closest('.wizard-container');
                const currentPage = e.target.closest('.wizard-page');
                let currentPageIndex = parseInt(currentPage.dataset.pageIndex, 10);
                currentPageIndex += e.target.matches('.next') ? 1 : -1;
                currentPage.classList.remove('active');
                wizardContainer.querySelector(`.wizard-page[data-page-index="${currentPageIndex}"]`).classList.add('active');
            }
        });
        
        // Show first page of each wizard
        document.querySelectorAll('.wizard-container').forEach(container => container.querySelector('.wizard-page')?.classList.add('active'));
        
        // --- FINAL SUBMISSION LOGIC (HIDDEN IFRAME METHOD) ---
        document.getElementById('evaluation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting... Please Wait';

            try {
                // Create a single hidden iframe to handle all submissions
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden-submission-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                const { formResponseUrl, prolificCompletionUrl, entry_ids: entryIds } = masterFormBlueprint;
                const allFormData = new FormData(document.getElementById('evaluation-form'));
                
                // Function to submit a single task's data via a hidden form
                const submitTaskData = (simplification, simpIndex) => {
                    const dataToSubmit = {};
                    
                    dataToSubmit[entryIds.prolific_id] = prolificId;
                    dataToSubmit[entryIds.document_title] = simplification.title;
                    dataToSubmit[entryIds.simplification_model_id] = simplification.model_id;

                    simplification.evaluation.overall_questions.forEach(q => {
                        const entryKey = (q.key === 'overall_impression') ? 'overall_quality' : q.key;
                        dataToSubmit[entryIds[entryKey]] = allFormData.get(`s${simpIndex}_${q.key}`) || '';
                    });

                    simplification.evaluation.simplicity_issues.forEach((issue, issueIndex) => {
                        const spanNum = issueIndex + 1;
                        if (entryIds[`span_${spanNum}_text_id`]) {
                            dataToSubmit[entryIds[`span_${spanNum}_text_id`]] = issue.simplified_span || 'SPAN_NOT_FOUND';
                        }
                        dataToSubmit[entryIds[`span_${spanNum}_severity_id`]] = allFormData.get(`s${simpIndex}_span${issueIndex}_severity`) || '';
                        dataToSubmit[entryIds[`span_${spanNum}_explanation_id`]] = allFormData.get(`s${simpIndex}_span${issueIndex}_explanation`) || '';
                        dataToSubmit[entryIds[`span_${spanNum}_fix_id`]] = allFormData.get(`s${simpIndex}_span${issueIndex}_fix`) || '';
                    });

                    const missedIssuesText = allFormData.get(`s${simpIndex}_missed_issues_text`);
                    const isNoneChecked = allFormData.get(`s${simpIndex}_missed_issues_none`);
                    dataToSubmit[entryIds.missed_issues_text] = isNoneChecked ? 'None' : missedIssuesText || '';
                    dataToSubmit[entryIds.missed_issues_none] = isNoneChecked ? 'Checked' : '';
                    
                    if (simpIndex === taskData.length - 1) {
                        if (entryIds.final_comparison_choice) {
                            dataToSubmit[entryIds.final_comparison_choice] = allFormData.get('final_choice') || '';
                        }
                    }

                    const form = document.createElement('form');
                    form.action = formResponseUrl;
                    form.method = 'POST';
                    form.target = iframe.name;

                    for (const key in dataToSubmit) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = dataToSubmit[key];
                        form.appendChild(input);
                    }

                    document.body.appendChild(form);
                    form.submit();
                    document.body.removeChild(form);
                };

                // Submit data for each task
                taskData.forEach(submitTaskData);

                // Redirect after a delay
                setTimeout(() => {
                    window.location.href = prolificCompletionUrl;
                }, 2500);
            
            } catch (error) {
                console.error("A critical error occurred during submission:", error);
                alert("A critical error occurred while submitting data. Please contact the researcher.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit All Evaluations';
            }
        });
    }

    buildInterface();
});
</script>

</body>
</html>